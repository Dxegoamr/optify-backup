import{j as e,ab as j,a8 as B,s as T,y as D,d as F}from"./ui-vendor-COgSaoh6.js";import{i as U,r as o,L as P}from"./react-vendor-a_rYd-gI.js";import{D as S}from"./DashboardLayout-gNRGy55i.js";import{i as A,d as L,C as z,B as b,U as E}from"./index-CpWZ38xQ.js";import{e as M}from"./env-14fk--Ss.js";import{e as q,I as O}from"./firebase-vendor-BE8L9dHK.js";import"./input-QpeNTTno.js";import"./index-Ba2OgRVY.js";import"./chart-vendor-2xH8hKrZ.js";function ee({mode:p}){const[I]=U(),u=I.get("payment_id"),[$,k]=o.useState(null),[R,v]=o.useState(!0),[t,f]=o.useState(p),[x,w]=o.useState(!1),[d,h]=o.useState(null),[C,N]=o.useState(p!=="pending"),{user:s}=A(),y=async()=>{if(s?.uid)try{const r=await E.getUserProfile(s.uid);h(r)}catch(r){console.error("Erro ao buscar perfil:",r)}},g=async()=>{if(u){w(!0);try{const m=`${M.API_URL||"https://us-central1-optify-definitivo.cloudfunctions.net"}/checkPaymentStatus?paymentId=${u}`;console.log("üîç Verificando status do pagamento:",m);const a=await fetch(m,{method:"GET",headers:{"Content-Type":"application/json"}}),l=a.headers.get("content-type");if(!l||!l.includes("application/json")){const i=await a.text();throw console.error("‚ùå Resposta n√£o √© JSON:",i.substring(0,200)),new Error(`Resposta inv√°lida: ${a.status} ${a.statusText}`)}if(!a.ok)throw new Error(`Erro HTTP: ${a.status} ${a.statusText}`);const c=await a.json();if(console.log("‚úÖ Status do pagamento recebido:",c?.status),k(c),c?.status==="approved"&&(f("success"),s?.uid)){const i=await E.getUserProfile(s.uid);h(i),setTimeout(()=>{i?.plano&&(console.log("üîÑ Disparando evento planChanged para atualizar limita√ß√µes:",i.plano),window.dispatchEvent(new CustomEvent("planChanged",{detail:{userId:s.uid,newPlan:i.plano}})))},500)}}catch(r){console.error("‚ùå Erro ao verificar status:",r)}finally{w(!1)}}};o.useEffect(()=>{s?.uid&&y()},[s?.uid]),o.useEffect(()=>{if(!s?.uid)return;console.log("üëÇ Iniciando listener do Firestore para plano do usu√°rio");const r=q(L,"users",s.uid),m=O(r,a=>{if(a.exists()){const l=a.data(),c=l?.plano||l?.plan||"free",i=d?.plano||"free";console.log("üìä Plano atualizado no Firestore:",{previousPlan:i,newPlan:c,isSubscriber:l?.isSubscriber,isActive:l?.isActive}),h(l),c!==i&&(console.log("üìä Plano mudou, atualizando limita√ß√µes:",{previousPlan:i,newPlan:c}),window.dispatchEvent(new CustomEvent("planChanged",{detail:{userId:s.uid,newPlan:c}})),c!=="free"&&t==="pending"&&(console.log("‚úÖ Plano ativado! Mudando para success"),f("success")))}},a=>{console.error("‚ùå Erro no listener do Firestore:",a)});return()=>{console.log("üîá Removendo listener do Firestore"),m()}},[s?.uid,t]),o.useEffect(()=>{d?.plano&&d.plano!=="free"&&t==="pending"&&(console.log("‚úÖ Plano detectado! Mudando para success"),f("success"),s?.uid&&window.dispatchEvent(new CustomEvent("planChanged",{detail:{userId:s.uid,newPlan:d.plano}})))},[d?.plano,t,s?.uid]),o.useEffect(()=>{t==="success"&&p!=="success"?setTimeout(()=>{N(!0)},500):N(!0)},[t,p]),o.useEffect(()=>{if(!u){v(!1);return}if(g(),v(!1),t==="pending"){const r=setInterval(()=>{g(),y()},5e3);return()=>clearInterval(r)}},[u,t]);const n=(()=>{switch(t){case"success":return{icon:F,title:"Pagamento Aprovado!",description:"Seu plano foi ativado com sucesso. Aproveite todos os recursos!",iconBg:"bg-emerald-500/10",iconColor:"text-emerald-500",titleColor:"text-foreground",descriptionColor:"text-muted-foreground",cardBg:"bg-background border-border",buttonVariant:"default",showRefresh:!1};case"failure":return{icon:D,title:"Pagamento Falhou",description:"N√£o foi poss√≠vel processar seu pagamento. Tente novamente.",iconBg:"bg-red-500/10",iconColor:"text-red-500",titleColor:"text-foreground",descriptionColor:"text-muted-foreground",cardBg:"bg-background border-border",buttonVariant:"default",showRefresh:!0};case"pending":return{icon:T,title:"Pagamento Pendente",description:"Seu pagamento est√° sendo processado. Verificando status automaticamente...",iconBg:"bg-amber-500/10",iconColor:"text-amber-500",titleColor:"text-foreground",descriptionColor:"text-muted-foreground",cardBg:"bg-background border-border",buttonVariant:"outline",showRefresh:!0}}})(),V=n.icon;return R?e.jsx(S,{children:e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(j,{className:"h-6 w-6 animate-spin text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground",children:"Carregando..."})]})})}):e.jsx(S,{children:e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4 relative",children:e.jsx(z,{className:`w-full max-w-2xl p-8 ${n.cardBg} border shadow-lg transition-all duration-1000 ${C?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:`p-4 rounded-full ${n.iconBg} transition-all duration-1000 ${C?"scale-100":"scale-0"}`,children:e.jsx(V,{className:`h-12 w-12 ${n.iconColor} ${t==="success"?"animate-pulse":""}`})})}),e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("h1",{className:`text-4xl font-bold ${n.titleColor}`,children:n.title}),e.jsx("p",{className:`text-lg ${n.descriptionColor} max-w-md mx-auto`,children:n.description})]}),u&&e.jsx("div",{className:"bg-muted/50 rounded-xl p-6 border",children:e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("h3",{className:"font-semibold text-foreground",children:"Detalhes do Pagamento"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["ID: ",e.jsx("span",{className:"font-mono bg-muted px-2 py-1 rounded",children:u})]}),d?.plano&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Plano Atual: ",e.jsx("span",{className:"font-semibold text-foreground capitalize",children:d.plano})]})]})}),x&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-muted-foreground",children:[e.jsx(j,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm",children:"Verificando status..."})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-center",children:[e.jsx(b,{asChild:!0,className:"flex items-center gap-2",children:e.jsxs(P,{to:"/planos",children:[e.jsx(B,{className:"h-4 w-4"}),"Voltar aos Planos"]})}),e.jsx(b,{asChild:!0,variant:n.buttonVariant,children:e.jsx(P,{to:"/dashboard",children:"Ir para Dashboard"})}),n.showRefresh&&e.jsxs(b,{variant:"outline",onClick:g,disabled:x,className:"flex items-center gap-2",children:[e.jsx(j,{className:`h-4 w-4 ${x?"animate-spin":""}`}),"Verificar Status"]})]}),e.jsxs("div",{className:"text-center space-y-2 text-sm text-muted-foreground",children:[t==="success"&&e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"‚úÖ Seu plano foi ativado automaticamente"}),e.jsx("p",{children:"üéâ Voc√™ pode gerenciar sua assinatura no seu perfil"})]}),t==="failure"&&e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"‚ùå Se o problema persistir, entre em contato conosco"}),e.jsx("p",{children:"üí≥ Verifique se seus dados de pagamento est√£o corretos"})]}),t==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"‚è≥ O processamento pode levar alguns minutos"}),e.jsx("p",{children:"üìß Voc√™ receber√° um email quando o pagamento for confirmado"}),e.jsx("p",{children:"üîÑ Esta p√°gina atualiza automaticamente"})]})]}),$&&!1]})})})})}export{ee as default};
