var we=Object.defineProperty;var Ne=(r,o,i)=>o in r?we(r,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):r[o]=i;var se=(r,o,i)=>Ne(r,typeof o!="symbol"?o+"":o,i);import{n as Se,u as be,j as e,l as Ce,i as b,o as ae,e as ne,p as Me,q as Te,r as $e,L as Ae,D as he,U as ge,F as Fe,s as Ie,t as Pe}from"./ui-vendor-CIJA2k99.js";import{D as Re}from"./DashboardLayout-BStG2aYf.js";import{S as Ee}from"./stat-card-PrgjN6Di.js";import{i as H,C as ie,B as q,j as ke,k as U,l as Le,m as Be}from"./index-mvhQqbRd.js";import{r as C,R as Oe,u as Ye}from"./react-vendor-a_rYd-gI.js";import{D as fe,a as Ue,b as xe,c as ye,d as ve}from"./dialog-DVx2yULl.js";import{I as re}from"./input-foYkf2QR.js";import{L as G}from"./label-5IA6As71.js";import{u as W,a as le,b as Ge,c as De,d as qe,e as We}from"./useFirestore-lcCxN-bk.js";import{U as pe}from"./user-config.service-xkz0Ual-.js";import{S as Z,a as K,b as X,c as ee,d as Y}from"./select-BwImaozO.js";import{f as V}from"./format-DPwKrYwk.js";import{p as Ve}from"./pt-BR-DnZ5gAgy.js";import{a as He,b as oe}from"./user-specific.service-CELv746m.js";import"./firebase-vendor-Dsl9zeYT.js";import"./index-CnEst0fN.js";import"./chart-vendor-D_ps4xzz.js";import"./user-subcollections.service-BgWJVIJ-.js";import"./index-CdAzXW5_.js";const ze=()=>{const r=Se(),{user:o}=H(),[i,u]=C.useState(""),[h,f]=C.useState(!1),{data:x}=be({queryKey:["user-config",o?.uid],queryFn:async()=>o?.uid?pe.getUserConfig(o.uid):null,enabled:!!o?.uid}),[y,D]=C.useState(x?.monthlyGoal||1e4);Oe.useEffect(()=>{x?.monthlyGoal&&D(x.monthlyGoal)},[x]);const l=new Date,v=new Date(l.getFullYear(),l.getMonth(),1),S=new Date(l.getFullYear(),l.getMonth()+1,0),I=v.toISOString().split("T")[0],B=S.toISOString().split("T")[0],{data:$=[]}=W(o?.uid||"",I,B),{data:R=[]}=le(o?.uid||""),E=l.getFullYear(),m=l.getMonth(),n=R.filter(t=>{const d=new Date(t.date);return d.getFullYear()===E&&d.getMonth()===m}),c=n.reduce((t,d)=>t+(d.profit||d.margin||0),0),p=new Set(n.map(t=>t.date)),j=$.filter(t=>!p.has(t.date)),w=j.reduce((t,d)=>{const N=d.type==="withdraw"?d.amount:-d.amount;return t+N},0),M=c+w,k=async()=>{const t=Number(i);if(t<=0){b.error("A meta deve ser maior que zero");return}try{o?.uid&&await pe.updateMonthlyGoal(o.uid,t),D(t),b.success("Meta atualizada!"),f(!1),u(""),r.invalidateQueries({queryKey:["user-config",o?.uid]})}catch(d){console.error("Erro ao atualizar meta:",d),b.error("Erro ao atualizar meta. Tente novamente.")}},A=y>0?Math.min(M/y*100,100):0;return console.log("MonthlyGoalCard Debug:",{monthlyProfit:M,monthlyGoal:y,progress:A,monthlyTransactions:$.length,monthlySummaries:n.length,monthlyRevenueFromSummaries:c,openTransactions:j.length,monthlyRevenueFromTransactions:w,startDate:I,endDate:B}),console.log("MonthlyGoalCard - Fechamentos Diários:"),n.forEach((t,d)=>{console.log(`  ${d+1}. Data: ${t.date}, Profit: ${t.profit||t.margin||0}`)}),console.log("MonthlyGoalCard - Transações Abertas:"),j.forEach((t,d)=>{const N=t.type==="withdraw"?t.amount:-t.amount;console.log(`  ${d+1}. Data: ${t.date}, Tipo: ${t.type}, Valor: ${t.amount}, Profit: ${N}`)}),e.jsxs(ie,{className:"p-4 lg:p-6 shadow-card",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Meta Mensal"}),e.jsxs("p",{className:"text-2xl lg:text-3xl font-bold leading-tight",children:["R$ ",y.toLocaleString("pt-BR")]})]}),e.jsxs(fe,{open:h,onOpenChange:f,children:[e.jsx(Ue,{asChild:!0,children:e.jsx("button",{className:"p-3 lg:p-4 bg-gradient-primary rounded-xl shadow-glow hover:shadow-glow-lg transition-all duration-300 cursor-pointer flex-shrink-0 ml-4",children:e.jsx(Ce,{className:"h-5 w-5 lg:h-6 lg:w-6 text-primary-foreground"})})}),e.jsxs(xe,{children:[e.jsx(ye,{children:e.jsx(ve,{children:"Alterar Meta Mensal"})}),e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{children:[e.jsx(G,{children:"Nova Meta (R$)"}),e.jsx(re,{type:"number",step:"0.01",placeholder:"0,00",value:i,onChange:t=>u(t.target.value)})]}),e.jsx(q,{className:"w-full",onClick:k,children:"Salvar Meta"})]})]})]})]}),e.jsxs("div",{className:"space-y-3 mb-4",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Progresso"}),e.jsxs("span",{className:"font-semibold text-primary",children:[A.toFixed(1),"%"]})]}),e.jsxs("div",{className:"relative w-full h-4 bg-muted rounded-full overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 left-0 h-full gradient-primary transition-all duration-1000 ease-out rounded-full",style:{width:`${Math.min(A,100)}%`,minWidth:A>0?"2px":"0px"}}),A>100&&e.jsx("div",{className:"absolute top-0 left-0 h-full gradient-success transition-all duration-1000 ease-out rounded-full w-full"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["R$ ",M.toLocaleString("pt-BR")," de R$ ",y.toLocaleString("pt-BR")]})]})]})},Qe=({date:r})=>{const{user:o}=H(),[i,u]=C.useState(""),[h,f]=C.useState(""),[x,y]=C.useState("none"),[D,l]=C.useState("none"),[v,S]=C.useState("none"),[I,B]=C.useState("none"),$=V(r,"yyyy-MM-dd"),{data:R=[]}=Ge(o?.uid||""),{data:E=[]}=De(o?.uid||""),{data:m=[]}=W(o?.uid||""),n=m.filter(t=>t.date===$),c=qe(),p=We(),j=async(t,d,N,z)=>{if(!o?.uid||!d){b.error("Preencha o valor da transação");return}try{const O={userId:o.uid,employeeId:z==="none"?"":z||"",platformId:N==="none"?"":N||"",type:t,amount:Number(d),date:$};console.log("Creating transaction for date:",$,O),console.log("Transaction data being sent:",JSON.stringify(O,null,2));const te=await c.mutateAsync(O);console.log("Transaction created successfully with ID:",te),b.success(`${t==="deposit"?"Depósito":"Saque"} registrado com sucesso!`),t==="deposit"?(u(""),y("none"),S("none")):(f(""),l("none"),B("none"))}catch(O){console.error("Erro ao criar transação:",O),console.error("Error details:",O),b.error("Erro ao registrar transação: "+O.message)}},w=async t=>{try{await p.mutateAsync(t),b.success("Transação excluída com sucesso!")}catch(d){console.error("Erro ao excluir transação:",d),b.error("Erro ao excluir transação")}},M=t=>t&&R.find(N=>N.id===t)?.name||"N/A",k=t=>R.find(N=>N.id===t)?.color||"#666",A=t=>t&&E.find(N=>N.id===t)?.name||"N/A";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-2xl font-bold mb-2",children:["Transações - ",V(r,"dd 'de' MMMM 'de' yyyy",{locale:Ve})]}),e.jsx("p",{className:"text-muted-foreground",children:"Gerencie as movimentações deste dia"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-5 w-5 text-destructive"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Registrar Depósito"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"deposit-amount",children:"Valor (R$)"}),e.jsx(re,{id:"deposit-amount",type:"number",step:"0.01",placeholder:"0,00",value:i,onChange:t=>u(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"deposit-platform",children:"Plataforma (opcional)"}),e.jsxs(Z,{value:x,onValueChange:y,children:[e.jsx(K,{children:e.jsx(X,{placeholder:"Selecione uma plataforma..."})}),e.jsxs(ee,{children:[e.jsx(Y,{value:"none",children:"Nenhuma plataforma"}),R.map(t=>e.jsx(Y,{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"deposit-employee",children:"Funcionário (opcional)"}),e.jsxs(Z,{value:v,onValueChange:S,children:[e.jsx(K,{children:e.jsx(X,{placeholder:"Selecione um funcionário..."})}),e.jsxs(ee,{children:[e.jsx(Y,{value:"none",children:"Nenhum funcionário"}),E.map(t=>e.jsx(Y,{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs(q,{onClick:()=>j("deposit",i,x,v),className:"w-full gap-2",disabled:!i||c.isPending,children:[e.jsx(ae,{className:"h-4 w-4"}),"Registrar Depósito"]})]}),e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-5 w-5 text-success"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Registrar Saque"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"withdraw-amount",children:"Valor (R$)"}),e.jsx(re,{id:"withdraw-amount",type:"number",step:"0.01",placeholder:"0,00",value:h,onChange:t=>f(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"withdraw-platform",children:"Plataforma (opcional)"}),e.jsxs(Z,{value:D,onValueChange:l,children:[e.jsx(K,{children:e.jsx(X,{placeholder:"Selecione uma plataforma..."})}),e.jsxs(ee,{children:[e.jsx(Y,{value:"none",children:"Nenhuma plataforma"}),R.map(t=>e.jsx(Y,{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"withdraw-employee",children:"Funcionário (opcional)"}),e.jsxs(Z,{value:I,onValueChange:B,children:[e.jsx(K,{children:e.jsx(X,{placeholder:"Selecione um funcionário..."})}),e.jsxs(ee,{children:[e.jsx(Y,{value:"none",children:"Nenhum funcionário"}),E.map(t=>e.jsx(Y,{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs(q,{onClick:()=>j("withdraw",h,D,I),className:"w-full gap-2",disabled:!h||c.isPending,children:[e.jsx(ne,{className:"h-4 w-4"}),"Registrar Saque"]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Transações do Dia"}),n.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Nenhuma transação registrada para este dia"}):e.jsx("div",{className:"space-y-2",children:n.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-accent/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ke,{variant:t.type==="deposit"?"default":"destructive",style:{backgroundColor:k(t.platformId)},children:t.type==="deposit"?"Depósito":"Saque"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:M(t.platformId)}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[A(t.employeeId)!=="N/A"&&e.jsxs("span",{className:"block",children:["Funcionário: ",A(t.employeeId)]}),e.jsx("span",{children:V(new Date(t.createdAt?.toDate?.()||t.date),"HH:mm")})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:`font-bold ${t.type==="deposit"?"text-destructive":"text-success"}`,children:[t.type==="deposit"?"+":"-","R$ ",Number(t.amount).toLocaleString("pt-BR")]}),e.jsx(q,{variant:"ghost",size:"icon",onClick:()=>w(t.id),className:"text-destructive hover:text-destructive",children:e.jsx(Me,{className:"h-4 w-4"})})]})]},t.id))})]}),n.length>0&&e.jsxs("div",{className:"p-4 bg-muted/50 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Resumo do Dia"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Depósitos"}),e.jsxs("div",{className:"font-bold text-foreground",children:["R$ ",n.filter(t=>t.type==="deposit").reduce((t,d)=>t+Number(d.amount),0).toLocaleString("pt-BR")]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Saques"}),e.jsxs("div",{className:"font-bold text-foreground",children:["R$ ",n.filter(t=>t.type==="withdraw").reduce((t,d)=>t+Number(d.amount),0).toLocaleString("pt-BR")]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Lucro"}),e.jsxs("div",{className:`font-bold ${n.reduce((t,d)=>t+(d.type==="withdraw"?d.amount:-d.amount),0)>=0?"text-success":"text-destructive"}`,children:["R$ ",n.reduce((t,d)=>t+(d.type==="withdraw"?d.amount:-d.amount),0).toLocaleString("pt-BR")]})]})]})]})]})},_e=()=>{const[r,o]=C.useState(U()),[i,u]=C.useState(null),{user:h}=H(),{canEditPreviousCalendarDays:f}=Le(),{data:x=[]}=le(h?.uid||""),{data:y=[]}=W(h?.uid||"");console.log("MonthlyCalendar - Historical Summaries:",x),console.log("MonthlyCalendar - Historical Summaries length:",x?.length||0),console.log("MonthlyCalendar - All Transactions:",y),console.log("MonthlyCalendar - All Transactions length:",y?.length||0),console.log("MonthlyCalendar - Current Date:",r),console.log("MonthlyCalendar - User ID:",h?.uid);const D=C.useMemo(()=>{const m=new Map;return console.log("Calculating daily profits..."),x.forEach(n=>{let c;typeof n.date=="string"?c=n.date:n.date&&n.date.toDate?c=V(n.date.toDate(),"yyyy-MM-dd"):c=V(new Date(n.date),"yyyy-MM-dd"),console.log(`Adding historical profit for ${c}: ${n.profit||n.margin}`),m.set(c,n.profit||n.margin||0)}),y.forEach(n=>{const c=n.date;console.log(`Processing transaction for date ${c}:`,n);const p=n.type==="withdraw"?n.amount:-n.amount;if(m.has(c)){const j=m.get(c)||0,w=j+p;console.log(`Adding to existing profit for ${c}: ${j} + ${p} = ${w}`),m.set(c,w)}else console.log(`Creating new profit for ${c}: ${p}`),m.set(c,p)}),console.log("Final daily profits Map:",Array.from(m.entries())),m},[x,y]),l=["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"],v=m=>{const n=m.getFullYear(),c=m.getMonth(),p=new Date(n,c,1),w=new Date(n,c+1,0).getDate(),M=p.getDay();return{daysInMonth:w,startingDayOfWeek:M}},{daysInMonth:S,startingDayOfWeek:I}=v(r),B=()=>{o(new Date(r.getFullYear(),r.getMonth()-1))},$=()=>{o(new Date(r.getFullYear(),r.getMonth()+1))},R=m=>{const n=new Date(r.getFullYear(),r.getMonth(),m),c=V(n,"yyyy-MM-dd");console.log(`Looking for profit for day ${m}, date string: ${c}`);const p=D.get(c);return console.log(`Profit found for day ${m}:`,p),p},E=m=>{const n=new Date(r.getFullYear(),r.getMonth(),m),c=new Date;if(c.setHours(0,0,0,0),!f()&&n.getTime()!==c.getTime()){const p=n<c?"Edição de dias passados disponível apenas no plano Medium ou superior. Faça upgrade para acessar esta funcionalidade.":"Edição de dias futuros disponível apenas no plano Medium ou superior. Faça upgrade para acessar esta funcionalidade.";b.error(p);return}u(n)};return e.jsxs(e.Fragment,{children:[e.jsxs(ie,{className:"p-6 shadow-card",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h3",{className:"text-xl font-bold",children:[l[r.getMonth()]," ",r.getFullYear()]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(q,{variant:"outline",size:"icon",onClick:B,children:e.jsx(Te,{className:"h-4 w-4"})}),e.jsx(q,{variant:"outline",size:"icon",onClick:$,children:e.jsx($e,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-7 gap-2",children:[["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"].map(m=>e.jsx("div",{className:"text-center text-sm font-semibold text-muted-foreground p-2",children:m},m)),Array.from({length:I}).map((m,n)=>e.jsx("div",{},`empty-${n}`)),Array.from({length:S}).map((m,n)=>{const c=n+1,p=R(c),j=new Date(r.getFullYear(),r.getMonth(),c),w=new Date;w.setHours(0,0,0,0);const M=j.getTime()===w.getTime(),k=j<w,A=j>w,t=!f()&&(k||A);return e.jsxs("button",{onClick:()=>E(c),className:`
                  min-h-[80px] p-3 rounded-lg border transition-all hover:shadow-md relative group
                  ${M?"border-primary border-2":"border-border"}
                  ${k&&p!==void 0?"bg-muted/50":"bg-card"}
                  hover:bg-accent
                `,children:[e.jsx("div",{className:"absolute top-2 right-2 text-lg font-bold text-primary group-hover:text-black transition-colors duration-200",children:c}),t&&e.jsx("div",{className:"absolute top-2 left-2",children:e.jsx(Ae,{className:"h-3 w-3 text-muted-foreground"})}),p!==void 0&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full pt-4",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"BRL"}),e.jsxs("div",{className:`text-sm font-bold ${p>=0?"text-success":"text-destructive"}`,children:[p>=0?"+":"","R$ ",p.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]},c)})]})]}),e.jsx(fe,{open:!!i,onOpenChange:m=>!m&&u(null),children:e.jsxs(xe,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ye,{children:e.jsxs(ve,{children:["Transações - ",i?.toLocaleDateString("pt-BR",{day:"2-digit",month:"long",year:"numeric"})]})}),i&&e.jsx(Qe,{date:i})]})})]})};class F{static startDailyClosureService(o){this.stopDailyClosureService();const i=this.getNextMidnightInSaoPaulo(),u=i.getTime()-new Date().getTime();console.log("🕛 Serviço de fechamento diário iniciado"),console.log(`📅 Próximo fechamento em: ${i.toLocaleString("pt-BR",{timeZone:"America/Sao_Paulo"})}`),this.closureInterval=setTimeout(()=>{this.processDailyClosure(o),this.closureInterval=setInterval(()=>{this.processDailyClosure(o)},24*60*60*1e3)},u)}static stopDailyClosureService(){this.closureInterval&&(clearTimeout(this.closureInterval),clearInterval(this.closureInterval),this.closureInterval=null,console.log("🛑 Serviço de fechamento diário parado"))}static async processManualClosure(o,i){const u=i||this.getCurrentDateInSaoPaulo();await this.processDailyClosure(o,u)}static async processDailyClosure(o,i){if(this.isProcessing){console.log("⚠️ Fechamento diário já está sendo processado");return}this.isProcessing=!0;const u=i||this.getCurrentDateInSaoPaulo();try{console.log(`🔄 Iniciando fechamento diário para ${u}`);const h=await He.getTransactionsByDateRange(o,u,u);if(h.length===0){console.log("📝 Nenhuma transação encontrada para o dia"),this.isProcessing=!1;return}const f=await this.calculateDailySummary(o,u,h),x=await this.getExistingSummary(o,u);x?(console.log("📝 Atualizando resumo existente"),await oe.updateDailySummary(o,x.id,f)):(console.log("📝 Criando novo resumo diário"),await oe.createDailySummary(o,f)),console.log(`✅ Fechamento diário concluído para ${u}`),console.log(`📊 Resumo: ${f.totalDeposits} depósitos, ${f.totalWithdraws} saques, ${f.totalProfit} lucro`)}catch(h){console.error("❌ Erro no fechamento diário:",h)}finally{this.isProcessing=!1}}static async calculateDailySummary(o,i,u){const h=u.filter(l=>l.type==="deposit").reduce((l,v)=>l+(v.amount||0),0),f=u.filter(l=>l.type==="withdraw").reduce((l,v)=>l+(v.amount||0),0),x=f-h,y=u.reduce((l,v)=>{const S=v.employeeId;return l[S]||(l[S]={employeeId:S,employeeName:"Funcionário não encontrado",deposits:0,withdraws:0,profit:0,transactionCount:0}),v.type==="deposit"?l[S].deposits+=v.amount||0:l[S].withdraws+=v.amount||0,l[S].transactionCount++,l},{});Object.values(y).forEach(l=>{l.profit=l.withdraws-l.deposits});const D=Object.values(y);return{date:i,totalDeposits:h,totalWithdraws:f,totalProfit:x,transactionCount:u.length,employeeSummaries:D}}static async getExistingSummary(o,i){try{return(await oe.getDailySummaries(o)).find(h=>h.date===i)||null}catch(u){return console.error("Erro ao buscar resumo existente:",u),null}}static getNextMidnightInSaoPaulo(){const o=new Date,i=new Date(o.toLocaleString("en-US",{timeZone:"America/Sao_Paulo"})),u=new Date(i);return u.setDate(u.getDate()+1),u.setHours(0,0,0,0),new Date(u.toLocaleString("en-US",{timeZone:"UTC"}))}static getCurrentDateInSaoPaulo(){return new Date().toLocaleDateString("en-CA",{timeZone:"America/Sao_Paulo"})}static isServiceActive(){return this.closureInterval!==null}static getNextClosureInfo(){return{nextClosure:this.getNextMidnightInSaoPaulo(),isActive:this.isServiceActive()}}}se(F,"closureInterval",null),se(F,"isProcessing",!1);const Je=()=>{const{user:r}=H(),[o,i]=C.useState(!1),[u,h]=C.useState(null);return C.useEffect(()=>{if(r?.uid){console.log("🚀 Iniciando serviço de fechamento diário para usuário:",r.uid),F.startDailyClosureService(r.uid),i(F.isServiceActive());const{nextClosure:D}=F.getNextClosureInfo();h(D);const l=setInterval(()=>{i(F.isServiceActive());const{nextClosure:v}=F.getNextClosureInfo();h(v)},6e4);return()=>{clearInterval(l),F.stopDailyClosureService(),console.log("🛑 Serviço de fechamento diário parado")}}},[r?.uid]),{isServiceActive:o,nextClosure:u,processManualClosure:async D=>{if(!r?.uid){b.error("Usuário não autenticado");return}try{b.loading("Processando fechamento diário...",{id:"daily-closure"}),await F.processManualClosure(r.uid,D),b.success("Fechamento diário processado com sucesso!",{id:"daily-closure"})}catch(l){console.error("Erro no fechamento manual:",l),b.error("Erro ao processar fechamento diário",{id:"daily-closure"})}},stopService:()=>{F.stopDailyClosureService(),i(!1),h(null),b.info("Serviço de fechamento diário parado")},restartService:()=>{if(r?.uid){F.startDailyClosureService(r.uid),i(F.isServiceActive());const{nextClosure:D}=F.getNextClosureInfo();h(D),b.success("Serviço de fechamento diário reiniciado")}}}},xt=()=>{const{user:r}=H(),o=Ye();Je();const{data:i=[],isLoading:u,error:h}=De(r?.uid||""),f=Be(),x=new Date(U().getTime()-7*24*60*60*1e3).toISOString().split("T")[0],y=new Date(U().getFullYear(),U().getMonth(),1).toISOString().split("T")[0],D=new Date(U().getFullYear(),U().getMonth()+1,0).toISOString().split("T")[0],{data:l=[],isLoading:v,error:S}=W(r?.uid||"",f,f),{data:I=[],isLoading:B}=W(r?.uid||"",x,f),{data:$=[],isLoading:R}=W(r?.uid||"",y,D),{data:E=[]}=le(r?.uid||"");console.log("Dashboard Debug:",{user:r?.uid,employees:i.length,todayTransactions:l.length,today:f,employeesLoading:u,transactionsLoading:v,employeesError:h,transactionsError:S});const m=l?.filter(s=>s.type==="deposit")?.reduce((s,a)=>s+(a.amount||0),0)||0,c=(l?.filter(s=>s.type==="withdraw")?.reduce((s,a)=>s+(a.amount||0),0)||0)-m,p=i?.filter(s=>s.status==="active")||[];l?.length;const j=U().getFullYear(),w=U().getMonth(),M=E.filter(s=>{const a=new Date(s.date);return a.getFullYear()===j&&a.getMonth()===w}),k=M.reduce((s,a)=>s+(a.profit||a.margin||0),0),A=new Set(M.map(s=>s.date)),t=$.filter(s=>!A.has(s.date)),d=t.reduce((s,a)=>{const g=a.type==="withdraw"?a.amount:-a.amount;return s+g},0);console.log("Dashboard - Transações Abertas (não fechadas):",{totalMonthlyTransactions:$.length,closedDates:Array.from(A),openTransactions:t.length,monthlyRevenueFromTransactions:d});const N=k+d;console.log("Dashboard - Cálculo Receita Mensal:",{currentYear:j,currentMonth:w,monthlySummaries:M.length,monthlyRevenueFromSummaries:k,monthlyTransactions:$.length,monthlyRevenueFromTransactions:d,monthlyRevenue:N}),console.log("Dashboard - Fechamentos Diários Detalhados:"),M.forEach((s,a)=>{console.log(`  ${a+1}. Data: ${s.date}, Profit: ${s.profit||s.margin||0}`)}),console.log("Dashboard - Transações Abertas Detalhadas:"),t.forEach((s,a)=>{const g=s.type==="withdraw"?s.amount:-s.amount;console.log(`  ${a+1}. Data: ${s.date}, Tipo: ${s.type}, Valor: ${s.amount}, Profit: ${g}`)}),p.length*1e4;const z=[{title:"Receita Hoje",value:`R$ ${c.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`,icon:he,valueColor:c>=0?"positive":"negative",clickable:!0,onClick:()=>o("/resumo-dia")},{title:"Receita do Mês",value:`R$ ${N.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`,icon:N>=0?ne:ae,valueColor:N>=0?"positive":"negative",clickable:!0,onClick:()=>o("/relatorios")},{title:"Funcionários Ativos",value:p.length.toString(),icon:ge,valueColor:"default",clickable:!0,onClick:()=>o("/gestao-funcionarios")},{title:"Transações do Mês",value:$.length.toString(),icon:Fe,valueColor:"default",clickable:!0,onClick:()=>{o("/relatorios"),setTimeout(()=>{const s=document.getElementById("weekly-chart-section");s&&s.scrollIntoView({behavior:"smooth",block:"start"})},500)}}];(()=>{const s=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"],a=[];for(let g=6;g>=0;g--){const T=new Date;T.setDate(T.getDate()-g);const L=T.toISOString().split("T")[0],me=I.filter(P=>new Date(P.createdAt?.toDate?.()||P.createdAt).toISOString().split("T")[0]===L),Q=me.filter(P=>P.type==="withdraw").reduce((P,J)=>P+(Number(J.amount)||0),0),_=me.filter(P=>P.type==="deposit").reduce((P,J)=>P+(Number(J.amount)||0),0),je=a.length>0?a[a.length-1].lucroAcumulado+Q-_:Q-_;a.push({name:s[T.getDay()],receita:Q,despesa:_,lucro:Q-_,lucroAcumulado:je,date:L,isToday:g===0})}return a})();const te=()=>{const s=[];return I.sort((a,g)=>new Date(g.createdAt?.toDate?.()||g.createdAt).getTime()-new Date(a.createdAt?.toDate?.()||a.createdAt).getTime()).slice(0,5).forEach(a=>{const g=i.find(L=>L.id===a.employeeId),T=ce(new Date(a.createdAt?.toDate?.()||a.createdAt));a.type==="withdraw"?s.push({id:`transaction-${a.id}`,action:"Pagamento recebido",employee:g?.name||"Funcionário não encontrado",value:`R$ ${Number(a.amount||0).toLocaleString("pt-BR")}`,time:T,type:"payment",icon:he}):a.type==="deposit"&&s.push({id:`transaction-${a.id}`,action:"Pagamento pendente",employee:g?.name||"Funcionário não encontrado",value:`R$ ${Number(a.amount||0).toLocaleString("pt-BR")}`,time:T,type:"pending",icon:Ie})}),i.sort((a,g)=>new Date(g.createdAt?.toDate?.()||g.createdAt).getTime()-new Date(a.createdAt?.toDate?.()||a.createdAt).getTime()).slice(0,2).forEach(a=>{const g=ce(new Date(a.createdAt?.toDate?.()||a.createdAt));s.push({id:`employee-${a.id}`,action:"Novo funcionário",employee:a.name,value:"",time:g,type:"employee",icon:Pe})}),s.sort((a,g)=>{const T=de(a.time),L=de(g.time);return T-L}).slice(0,5)},ce=s=>{const g=Math.floor((new Date-s)/(1e3*60));if(g<1)return"Agora mesmo";if(g<60)return`${g} min atrás`;const T=Math.floor(g/60);if(T<24)return`${T} hora${T>1?"s":""} atrás`;const L=Math.floor(T/24);return`${L} dia${L>1?"s":""} atrás`},de=s=>s==="Agora mesmo"?0:s.includes("min")?parseInt(s):s.includes("hora")?parseInt(s)*60:s.includes("dia")?parseInt(s)*24*60:999999,ue=te();return e.jsx(Re,{children:e.jsxs("div",{className:"space-y-8 animate-fade-in",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-4xl font-bold mb-2",children:"Dashboard"}),e.jsx("p",{className:"text-muted-foreground",children:"Visão geral do seu negócio"})]}),e.jsx("div",{className:"dashboard-grid",children:z.map(s=>e.jsx(Ee,{title:s.title,value:s.value,icon:s.icon,valueColor:s.valueColor,clickable:s.clickable,onClick:s.onClick},s.title))}),e.jsx(ze,{}),e.jsx(_e,{}),e.jsxs(ie,{className:"p-6 shadow-card hover:shadow-glow transition-all duration-300",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Atividades Recentes"}),e.jsx("div",{className:"space-y-4",children:ue.length>0?ue.map(s=>{const a=s.icon;return e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("div",{className:`p-2 rounded-full ${s.type==="payment"?"bg-success/10":s.type==="pending"?"bg-warning/10":"bg-primary/10"}`,children:e.jsx(a,{className:`h-4 w-4 ${s.type==="payment"?"text-success":s.type==="pending"?"text-warning":"text-primary"}`})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:s.action}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.employee})]})]}),e.jsxs("div",{className:"text-right",children:[s.value&&e.jsx("p",{className:`font-semibold ${s.type==="payment"?"text-success":s.type==="pending"?"text-warning":"text-foreground"}`,children:s.value}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.time})]})]},s.id)}):e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ge,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Nenhuma atividade recente"}),e.jsx("p",{className:"text-sm",children:"As atividades aparecerão aqui conforme você usa o sistema"})]})})]})]})})};export{xt as default};
