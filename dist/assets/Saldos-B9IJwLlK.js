import{n as de,j as e,P as Q,N as V,w as me,p as ue,i as d}from"./ui-vendor-COgSaoh6.js";import{r as p}from"./react-vendor-a_rYd-gI.js";import{D as he,A as xe,i as fe,a as pe,b as ge,c as je,d as be,e as Ce,f as Ne,g as ye}from"./DashboardLayout-gNRGy55i.js";import{P as ve}from"./ProtectedPageContent-Ct5ZdNix.js";import{i as Pe,B as u,C as G}from"./index-CpWZ38xQ.js";import{I as C}from"./input-QpeNTTno.js";import{L as v}from"./label-D3vsPjsu.js";import{c as we,b as De,u as Ae,h as Ee,i as Se,j as Te,k as Be,d as ke}from"./useFirestore-CBeuVY0f.js";import{D as k,a as F,b as z,c as $,d as I}from"./dialog-C2zfgNcX.js";import"./firebase-vendor-BE8L9dHK.js";import"./index-Ba2OgRVY.js";import"./chart-vendor-2xH8hKrZ.js";import"./user-specific.service-BRXRLJrk.js";import"./user-subcollections.service-Be66DGXL.js";const Xe=()=>{const q=de(),{user:c}=Pe(),[f,E]=p.useState({name:"",color:"#FF5C00"}),[m,N]=p.useState(null),[W,M]=p.useState(!1),[J,L]=p.useState(!1),[O,R]=p.useState(""),[S,U]=p.useState(null),[g,P]=p.useState({}),{data:T=[]}=we(c?.uid||""),{data:j=[]}=De(c?.uid||""),{data:w=[]}=Ae(c?.uid||"","","");console.log("Saldos - Employees:",T.length),console.log("Saldos - Platforms:",j.length),console.log("Saldos - Transactions:",w.length),console.log("Saldos - All Transactions:",w),console.log("Saldos - Platforms IDs:",j.map(a=>({id:a.id,name:a.name}))),w.forEach((a,s)=>{console.log(`Transaction ${s}:`,{id:a.id,employeeId:a.employeeId,platformId:a.platformId,type:a.type,amount:a.amount,date:a.date})});const X=Ee(),D=Se(),Y=Te(),B=Be(),Z=ke(),y=(()=>{const a={};return T.forEach(s=>{a[s.id]={name:s.name,platforms:{},total:0},j.forEach(t=>{const o=w.filter(r=>r.employeeId===s.id&&r.platformId===t.id);console.log(`Debug - Employee: ${s.name}, Platform: ${t.name}, Transactions:`,o);const n=o.filter(r=>r.description&&r.description.includes("Ajuste manual de saldo"));if(n.length>0){const r=n.sort((h,x)=>{const i=h.createdAt?.toDate?.()?.getTime()||(h.createdAt?.seconds?h.createdAt.seconds*1e3:0)||h.updatedAt?.toDate?.()?.getTime()||0,b=x.createdAt?.toDate?.()?.getTime()||(x.createdAt?.seconds?x.createdAt.seconds*1e3:0)||x.updatedAt?.toDate?.()?.getTime()||0;if(i===0&&b===0){const ce=new Date(h.date||0).getTime();return new Date(x.date||0).getTime()-ce}return b-i})[0],l=Number(r.amount||0);a[s.id].platforms[t.id]=l,a[s.id].total+=l}else{const r=o.filter(i=>!i.description||!i.description.includes("Ajuste manual de saldo")),l=r.filter(i=>i.type==="deposit").reduce((i,b)=>i+Number(b.amount||0),0),h=r.filter(i=>i.type==="withdraw").reduce((i,b)=>i+Number(b.amount||0),0);console.log(`Debug - Deposits: ${l}, Withdraws: ${h}`);const x=l-h;a[s.id].platforms[t.id]=Math.max(0,x),a[s.id].total+=Math.max(0,x)}})}),Object.values(a)})();console.log("Saldos - Platform Balances:",y);const _=[...T].sort((a,s)=>a.name.localeCompare(s.name)),A=j.filter(a=>a.isActive!==!1),K=[...A.reduce((a,s)=>(a.find(o=>o.id===s.id||o.name===s.name)||a.push(s),a),[])].sort((a,s)=>{const t=y.reduce((n,r)=>n+(Number(r.platforms?.[a.id])||0),0),o=y.reduce((n,r)=>n+(Number(r.platforms?.[s.id])||0),0);return Number(o)-Number(t)}),ee=y.reduce((a,s)=>a+(s.total||0),0),ae=j.filter(a=>a.name.toLowerCase().includes(O.toLowerCase())),se=(a,s,t)=>{const o=`${a}-${s}`;P({...g,[o]:{employeeId:a,platformId:s,value:t.toString()}})},H=async(a,s)=>{const t=`${a}-${s}`,o=g[t];if(o)try{const n=Number(o.value),r={userId:c?.uid||"",employeeId:a,platformId:s,type:"deposit",amount:Math.abs(n),date:new Date().toISOString().split("T")[0],description:"Ajuste manual de saldo"};await Z.mutateAsync(r),q.invalidateQueries({queryKey:["firebase-transactions"]}),await q.refetchQueries({queryKey:["firebase-transactions"]});const l={...g};delete l[t],P(l),d.success("Saldo atualizado!")}catch(n){console.error("Erro ao atualizar saldo:",n),d.error("Erro ao atualizar saldo")}},te=(a,s)=>{const t=`${a}-${s}`,o={...g};delete o[t],P(o)},oe=async()=>{if(c?.uid)try{await X.mutateAsync({userId:c.uid,name:f.name,color:f.color}),d.success("Casa de aposta criada!"),E({name:"",color:"#FF5C00"}),M(!1)}catch{d.error("Erro ao criar casa de aposta")}},re=async()=>{if(m)try{await D.mutateAsync({userId:c?.uid||"",id:m.id,data:{name:m.name,color:m.color}}),d.success("Casa de aposta atualizada!"),N(null)}catch{d.error("Erro ao atualizar casa de aposta")}},ne=async a=>{try{await Y.mutateAsync({userId:c?.uid||"",id:a}),d.success("Casa de aposta excluída!")}catch{d.error("Erro ao excluir casa de aposta")}},le=async()=>{if(c?.uid)try{await B.mutateAsync(c.uid),d.success("Plataformas padrão criadas com sucesso!")}catch{d.error("Erro ao criar plataformas padrão")}},ie=async()=>{if(c?.uid)try{const a=[{name:"Pixbet",color:"#ADD8E6"},{name:"Betano",color:"#FF6600"},{name:"Mcgames",color:"#DC143C"},{name:"Kto",color:"#C80000"},{name:"Realsbet",color:"#00FFC8"},{name:"Vaidebet",color:"#FFD700"},{name:"Sportingbet",color:"#4682B4"},{name:"Superbet",color:"#FF3366"},{name:"Betao",color:"#FFA550"},{name:"Bet365",color:"#008040"},{name:"Esportivabet",color:"#FF8C00"},{name:"Hiperbet",color:"#DC0000"},{name:"Luvabet",color:"#ADFF2F"},{name:"Cassinopix",color:"#87CEEB"},{name:"Multibet",color:"#483D8B"}],s=j.map(t=>{const o=a.find(n=>n.name===t.name);return o&&t.color!==o.color?D.mutateAsync({userId:c.uid,id:t.id,data:{color:o.color}}):Promise.resolve()});await Promise.all(s),d.success("Cores das plataformas atualizadas!")}catch{d.error("Erro ao atualizar cores das plataformas")}};return e.jsx(he,{children:e.jsx(ve,{requiredFeature:"balances",featureName:"Saldos",requiredPlan:"Medium",children:e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-4xl font-bold mb-2",children:"Saldos"}),e.jsx("p",{className:"text-muted-foreground",children:"Gerencie contas e saldos por plataforma"})]}),e.jsxs("div",{className:"flex gap-2",children:[A.length===0&&e.jsxs(u,{onClick:le,disabled:B.isPending,className:"gap-2",children:[e.jsx(Q,{className:"h-4 w-4"}),B.isPending?"Criando...":"Criar Plataformas Padrão"]}),A.length>0&&e.jsxs(u,{onClick:ie,disabled:D.isPending,variant:"outline",className:"gap-2",children:[e.jsx(V,{className:"h-4 w-4"}),D.isPending?"Atualizando...":"Atualizar Cores"]}),A.length>0&&e.jsxs(k,{open:J,onOpenChange:L,children:[e.jsx(F,{asChild:!0,children:e.jsxs(u,{variant:"outline",className:"gap-2",children:[e.jsx(me,{className:"h-4 w-4"}),"Pesquisar Plataforma"]})}),e.jsxs(z,{children:[e.jsx($,{children:e.jsx(I,{children:"Pesquisar Plataforma"})}),e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{children:[e.jsx(v,{children:"Nome da Plataforma"}),e.jsx(C,{placeholder:"Digite o nome da plataforma...",value:O,onChange:a=>R(a.target.value)})]}),e.jsx("div",{className:"max-h-60 overflow-y-auto",children:ae.map(a=>e.jsxs(u,{variant:"outline",className:"w-full justify-start mb-2",onClick:()=>{U(a),L(!1),R("")},children:[e.jsx("div",{className:"w-4 h-4 rounded mr-2",style:{backgroundColor:a.color}}),a.name]},a.id))})]})]})]}),e.jsxs(k,{open:W,onOpenChange:M,children:[e.jsx(F,{asChild:!0,children:e.jsxs(u,{variant:"outline",className:"gap-2",children:[e.jsx(Q,{className:"h-4 w-4"}),"Criar Casa"]})}),e.jsxs(z,{children:[e.jsx($,{children:e.jsx(I,{children:"Criar Casa de Aposta"})}),e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{children:[e.jsx(v,{children:"Nome"}),e.jsx(C,{value:f.name,onChange:a=>E({...f,name:a.target.value})})]}),e.jsxs("div",{children:[e.jsx(v,{children:"Cor"}),e.jsx(C,{type:"color",value:f.color,onChange:a=>E({...f,color:a.target.value})})]}),e.jsx(u,{className:"w-full",onClick:oe,disabled:!f.name.trim(),children:"Criar"})]})]})]})]})]}),e.jsxs(G,{className:"p-6 shadow-card gradient-success",children:[e.jsx("p",{className:"text-sm text-success-foreground/80 mb-2",children:"Saldo Total"}),e.jsxs("p",{className:"text-4xl font-bold text-success-foreground",children:["R$ ",Number(ee||0).toLocaleString("pt-BR")]})]}),e.jsxs(G,{className:"shadow-card overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Saldos por Plataforma"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Clique nos valores para editar. Os valores são salvos automaticamente ao sair do campo."}),S&&e.jsxs("div",{className:"mt-2 p-2 bg-muted rounded",children:[e.jsx("span",{className:"text-sm",children:"Filtrado por: "}),e.jsx("span",{className:"inline-block w-3 h-3 rounded mr-1",style:{backgroundColor:S.color}}),e.jsx("span",{className:"font-medium",children:S.name}),e.jsx(u,{variant:"ghost",size:"sm",onClick:()=>U(null),className:"ml-2 h-6 px-2",children:"Limpar filtro"})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-muted/50",children:[e.jsx("th",{className:"text-left p-4 font-semibold sticky left-0 bg-background z-10",children:"Funcionário"}),e.jsx("th",{className:"text-center p-4 font-semibold sticky left-20 bg-background z-10",children:"Total por Funcionário"}),K.map(a=>e.jsx("th",{className:"text-center p-4 font-semibold min-w-[120px]",style:{backgroundColor:a.color+"20"},children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-white font-medium",children:a.name}),e.jsxs(k,{open:m?.id===a.id,onOpenChange:s=>!s&&N(null),children:[e.jsx(F,{asChild:!0,children:e.jsx(u,{size:"icon",variant:"ghost",className:"h-6 w-6 text-white hover:bg-white/20",onClick:()=>N(a),children:e.jsx(V,{className:"h-3 w-3"})})}),e.jsxs(z,{children:[e.jsx($,{children:e.jsx(I,{children:"Editar Casa de Aposta"})}),e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{children:[e.jsx(v,{children:"Nome"}),e.jsx(C,{value:m?.name||"",onChange:s=>N({...m,name:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(v,{children:"Cor"}),e.jsx(C,{type:"color",value:m?.color||"#FF5C00",onChange:s=>N({...m,color:s.target.value})})]}),e.jsx(u,{className:"w-full",onClick:re,disabled:!m?.name?.trim(),children:"Salvar"})]})]})]}),e.jsxs(xe,{children:[e.jsx(fe,{asChild:!0,children:e.jsx(u,{size:"icon",variant:"ghost",className:"h-6 w-6 text-white hover:bg-white/20",children:e.jsx(ue,{className:"h-3 w-3"})})}),e.jsxs(pe,{children:[e.jsxs(ge,{children:[e.jsx(je,{children:"Excluir casa de aposta?"}),e.jsx(be,{children:"Esta ação não pode ser desfeita. Todas as transações relacionadas a esta plataforma serão mantidas."})]}),e.jsxs(Ce,{children:[e.jsx(Ne,{children:"Cancelar"}),e.jsx(ye,{onClick:()=>ne(a.id),children:"Excluir"})]})]})]})]})},a.id))]})}),e.jsx("tbody",{children:_.map(a=>{const s=y.find(t=>t.name===a.name);return e.jsxs("tr",{className:"border-t hover:bg-muted/30",children:[e.jsx("td",{className:"p-4 font-medium sticky left-0 bg-background z-10",children:a.name}),e.jsx("td",{className:"p-4 text-center font-bold sticky left-20 bg-background z-10",children:e.jsxs("span",{className:"text-success",children:["R$ ",(s?.total||0).toLocaleString("pt-BR")]})}),K.map(t=>{const o=`${a.id}-${t.id}`,n=g[o],r=s?.platforms?.[t.id]||0;return e.jsx("td",{className:"p-4 text-center",children:n?e.jsx("div",{className:"flex items-center gap-1",children:e.jsx(C,{type:"number",value:n.value,onChange:l=>P({...g,[o]:{...n,value:l.target.value}}),className:"w-20 h-8 text-center",onKeyDown:l=>{l.key==="Enter"?H(a.id,t.id):l.key==="Escape"&&te(a.id,t.id)},onBlur:()=>H(a.id,t.id),autoFocus:!0})}):e.jsxs("span",{className:"text-success cursor-pointer hover:bg-muted/50 p-1 rounded",onClick:()=>se(a.id,t.id,r),children:["R$ ",r.toLocaleString("pt-BR")]})},t.id)})]},a.id)})})]})})]})]})})})};export{Xe as default};
