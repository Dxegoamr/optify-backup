var De=Object.defineProperty;var we=(r,o,n)=>o in r?De(r,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[o]=n;var Q=(r,o,n)=>we(r,typeof o!="symbol"?o+"":o,n);import{n as je,u as Se,j as e,l as Ne,i as b,e as J,o as Z,p as be,q as Ce,r as Me,L as Te,D as re,U as ne,F as $e,s as Ae,t as Ie}from"./ui-vendor-BTHa3W3g.js";import{D as Pe}from"./DashboardLayout-D0U5gXbg.js";import{S as Re}from"./stat-card-D9VrWQ13.js";import{i as W,C as X,B as O,j as Fe,k as B,l as ke,m as Ee}from"./index-CK_VcXmi.js";import{r as A,R as Le,u as Be}from"./react-vendor-a_rYd-gI.js";import{D as he,a as Oe,b as ge,c as pe,d as fe}from"./dialog-DweZzZEV.js";import{I as K}from"./input-DNUTw7Z-.js";import{L as q}from"./label-OWFMbN__.js";import{u as Y,a as ee,b as Ue,c as Ye,d as Ge,e as qe}from"./useFirestore-ihhZCHwz.js";import{U as ie}from"./user-config.service-UDPtGpcL.js";import{S as le,a as ce,b as de,c as ue,d as me}from"./select-D365Vewe.js";import{f as G}from"./format-DPwKrYwk.js";import{p as We}from"./pt-BR-DnZ5gAgy.js";import{a as He,b as _}from"./user-specific.service-By038XwM.js";import"./firebase-vendor-D8A9P6qX.js";import"./index-DRrHU6GR.js";import"./chart-vendor-CfBne3GF.js";import"./user-subcollections.service-BF8E-pEG.js";import"./index-CdAzXW5_.js";const Ve=()=>{const r=je(),{user:o}=W(),[n,d]=A.useState(""),[g,f]=A.useState(!1),{data:x}=Se({queryKey:["user-config",o?.uid],queryFn:async()=>o?.uid?ie.getUserConfig(o.uid):null,enabled:!!o?.uid}),[v,j]=A.useState(x?.monthlyGoal||1e4);Le.useEffect(()=>{x?.monthlyGoal&&j(x.monthlyGoal)},[x]);const i=new Date,D=new Date(i.getFullYear(),i.getMonth(),1),N=new Date(i.getFullYear(),i.getMonth()+1,0),R=D.toISOString().split("T")[0],M=N.toISOString().split("T")[0],{data:T=[]}=Y(o?.uid||"",R,M),{data:U=[]}=ee(o?.uid||""),E=i.getFullYear(),h=i.getMonth(),l=U.filter(m=>{const S=new Date(m.date);return S.getFullYear()===E&&S.getMonth()===h}),c=l.reduce((m,S)=>m+(S.profit||S.margin||0),0),s=new Set(l.map(m=>m.date)),u=T.filter(m=>!s.has(m.date)),y=u.reduce((m,S)=>{const L=S.type==="withdraw"?S.amount:-S.amount;return m+L},0),w=c+y,F=async()=>{const m=Number(n);if(m<=0){b.error("A meta deve ser maior que zero");return}try{o?.uid&&await ie.updateMonthlyGoal(o.uid,m),j(m),b.success("Meta atualizada!"),f(!1),d(""),r.invalidateQueries({queryKey:["user-config",o?.uid]})}catch(S){console.error("Erro ao atualizar meta:",S),b.error("Erro ao atualizar meta. Tente novamente.")}},I=v>0?Math.min(w/v*100,100):0;return console.log("MonthlyGoalCard Debug:",{monthlyProfit:w,monthlyGoal:v,progress:I,monthlyTransactions:T.length,monthlySummaries:l.length,monthlyRevenueFromSummaries:c,openTransactions:u.length,monthlyRevenueFromTransactions:y,startDate:R,endDate:M}),console.log("MonthlyGoalCard - Fechamentos Diários:"),l.forEach((m,S)=>{console.log(`  ${S+1}. Data: ${m.date}, Profit: ${m.profit||m.margin||0}`)}),console.log("MonthlyGoalCard - Transações Abertas:"),u.forEach((m,S)=>{const L=m.type==="withdraw"?m.amount:-m.amount;console.log(`  ${S+1}. Data: ${m.date}, Tipo: ${m.type}, Valor: ${m.amount}, Profit: ${L}`)}),e.jsxs(X,{className:"p-4 lg:p-6 shadow-card",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Meta Mensal"}),e.jsxs("p",{className:"text-2xl lg:text-3xl font-bold leading-tight",children:["R$ ",v.toLocaleString("pt-BR")]})]}),e.jsxs(he,{open:g,onOpenChange:f,children:[e.jsx(Oe,{asChild:!0,children:e.jsx("button",{className:"p-3 lg:p-4 bg-gradient-primary rounded-xl shadow-glow hover:shadow-glow-lg transition-all duration-300 cursor-pointer flex-shrink-0 ml-4",children:e.jsx(Ne,{className:"h-5 w-5 lg:h-6 lg:w-6 text-primary-foreground"})})}),e.jsxs(ge,{children:[e.jsx(pe,{children:e.jsx(fe,{children:"Alterar Meta Mensal"})}),e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{children:[e.jsx(q,{children:"Nova Meta (R$)"}),e.jsx(K,{type:"number",step:"0.01",placeholder:"0,00",value:n,onChange:m=>d(m.target.value)})]}),e.jsx(O,{className:"w-full",onClick:F,children:"Salvar Meta"})]})]})]})]}),e.jsxs("div",{className:"space-y-3 mb-4",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Progresso"}),e.jsxs("span",{className:"font-semibold text-primary",children:[I.toFixed(1),"%"]})]}),e.jsxs("div",{className:"relative w-full h-4 bg-muted rounded-full overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 left-0 h-full gradient-primary transition-all duration-1000 ease-out rounded-full",style:{width:`${Math.min(I,100)}%`,minWidth:I>0?"2px":"0px"}}),I>100&&e.jsx("div",{className:"absolute top-0 left-0 h-full gradient-success transition-all duration-1000 ease-out rounded-full w-full"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["R$ ",w.toLocaleString("pt-BR")," de R$ ",v.toLocaleString("pt-BR")]})]})]})},ze=({date:r})=>{const{user:o}=W(),[n,d]=A.useState(""),[g,f]=A.useState(""),[x,v]=A.useState(""),[j,i]=A.useState(""),D=G(r,"yyyy-MM-dd"),{data:N=[]}=Ue(o?.uid||""),{data:R=[]}=Y(o?.uid||""),M=R.filter(s=>s.date===D),T=Ye(),U=Ge(),E=async(s,u,y)=>{if(!o?.uid||!u||!y){b.error("Preencha todos os campos");return}try{const w={userId:o.uid,employeeId:"",platformId:y,type:s,amount:Number(u),date:D};console.log("Creating transaction for date:",D,w),console.log("Transaction data being sent:",JSON.stringify(w,null,2));const F=await T.mutateAsync(w);console.log("Transaction created successfully with ID:",F),b.success(`${s==="deposit"?"Depósito":"Saque"} registrado com sucesso!`),s==="deposit"?(d(""),v("")):(f(""),i(""))}catch(w){console.error("Erro ao criar transação:",w),console.error("Error details:",w),b.error("Erro ao registrar transação: "+w.message)}},h=async s=>{try{await U.mutateAsync(s),b.success("Transação excluída com sucesso!")}catch(u){console.error("Erro ao excluir transação:",u),b.error("Erro ao excluir transação")}},l=s=>N.find(y=>y.id===s)?.name||"N/A",c=s=>N.find(y=>y.id===s)?.color||"#666";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-2xl font-bold mb-2",children:["Transações - ",G(r,"dd 'de' MMMM 'de' yyyy",{locale:We})]}),e.jsx("p",{className:"text-muted-foreground",children:"Gerencie as movimentações deste dia"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"h-5 w-5 text-success"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Registrar Depósito"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"deposit-amount",children:"Valor (R$)"}),e.jsx(K,{id:"deposit-amount",type:"number",step:"0.01",placeholder:"0,00",value:n,onChange:s=>d(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"deposit-platform",children:"Plataforma"}),e.jsxs(le,{value:x,onValueChange:v,children:[e.jsx(ce,{children:e.jsx(de,{placeholder:"Selecione..."})}),e.jsx(ue,{children:N.map(s=>e.jsx(me,{value:s.id,children:s.name},s.id))})]})]}),e.jsxs(O,{onClick:()=>E("deposit",n,x),className:"w-full gap-2",disabled:!n||!x||T.isPending,children:[e.jsx(J,{className:"h-4 w-4"}),"Registrar Depósito"]})]}),e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-5 w-5 text-destructive"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Registrar Saque"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"withdraw-amount",children:"Valor (R$)"}),e.jsx(K,{id:"withdraw-amount",type:"number",step:"0.01",placeholder:"0,00",value:g,onChange:s=>f(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"withdraw-platform",children:"Plataforma"}),e.jsxs(le,{value:j,onValueChange:i,children:[e.jsx(ce,{children:e.jsx(de,{placeholder:"Selecione..."})}),e.jsx(ue,{children:N.map(s=>e.jsx(me,{value:s.id,children:s.name},s.id))})]})]}),e.jsxs(O,{onClick:()=>E("withdraw",g,j),className:"w-full gap-2",disabled:!g||!j||T.isPending,children:[e.jsx(Z,{className:"h-4 w-4"}),"Registrar Saque"]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Transações do Dia"}),M.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Nenhuma transação registrada para este dia"}):e.jsx("div",{className:"space-y-2",children:M.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-accent/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Fe,{variant:s.type==="deposit"?"default":"destructive",style:{backgroundColor:c(s.platformId)},children:s.type==="deposit"?"Receita":"Despesa"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:l(s.platformId)}),e.jsx("div",{className:"text-sm text-muted-foreground",children:G(new Date(s.createdAt?.toDate?.()||s.date),"HH:mm")})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:`font-bold ${s.type==="deposit"?"text-success":"text-destructive"}`,children:[s.type==="deposit"?"+":"-","R$ ",Number(s.amount).toLocaleString("pt-BR")]}),e.jsx(O,{variant:"ghost",size:"icon",onClick:()=>h(s.id),className:"text-destructive hover:text-destructive",children:e.jsx(be,{className:"h-4 w-4"})})]})]},s.id))})]}),M.length>0&&e.jsxs("div",{className:"p-4 bg-muted/50 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Resumo do Dia"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Depósitos"}),e.jsxs("div",{className:"font-bold text-success",children:["R$ ",M.filter(s=>s.type==="deposit").reduce((s,u)=>s+Number(u.amount),0).toLocaleString("pt-BR")]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Saques"}),e.jsxs("div",{className:"font-bold text-destructive",children:["R$ ",M.filter(s=>s.type==="withdraw").reduce((s,u)=>s+Number(u.amount),0).toLocaleString("pt-BR")]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Lucro"}),e.jsxs("div",{className:`font-bold ${M.reduce((s,u)=>s+(u.type==="withdraw"?u.amount:-u.amount),0)>=0?"text-success":"text-destructive"}`,children:["R$ ",M.reduce((s,u)=>s+(u.type==="withdraw"?u.amount:-u.amount),0).toLocaleString("pt-BR")]})]})]})]})]})},Qe=()=>{const[r,o]=A.useState(B()),[n,d]=A.useState(null),{user:g}=W(),{canEditPreviousCalendarDays:f}=ke(),{data:x=[]}=ee(g?.uid||""),{data:v=[]}=Y(g?.uid||"");console.log("MonthlyCalendar - Historical Summaries:",x),console.log("MonthlyCalendar - Historical Summaries length:",x?.length||0),console.log("MonthlyCalendar - All Transactions:",v),console.log("MonthlyCalendar - All Transactions length:",v?.length||0),console.log("MonthlyCalendar - Current Date:",r),console.log("MonthlyCalendar - User ID:",g?.uid);const j=A.useMemo(()=>{const h=new Map;return console.log("Calculating daily profits..."),x.forEach(l=>{let c;typeof l.date=="string"?c=l.date:l.date&&l.date.toDate?c=G(l.date.toDate(),"yyyy-MM-dd"):c=G(new Date(l.date),"yyyy-MM-dd"),console.log(`Adding historical profit for ${c}: ${l.profit||l.margin}`),h.set(c,l.profit||l.margin||0)}),v.forEach(l=>{const c=l.date;console.log(`Processing transaction for date ${c}:`,l);const s=l.type==="withdraw"?l.amount:-l.amount;if(h.has(c)){const u=h.get(c)||0,y=u+s;console.log(`Adding to existing profit for ${c}: ${u} + ${s} = ${y}`),h.set(c,y)}else console.log(`Creating new profit for ${c}: ${s}`),h.set(c,s)}),console.log("Final daily profits Map:",Array.from(h.entries())),h},[x,v]),i=["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"],D=h=>{const l=h.getFullYear(),c=h.getMonth(),s=new Date(l,c,1),y=new Date(l,c+1,0).getDate(),w=s.getDay();return{daysInMonth:y,startingDayOfWeek:w}},{daysInMonth:N,startingDayOfWeek:R}=D(r),M=()=>{o(new Date(r.getFullYear(),r.getMonth()-1))},T=()=>{o(new Date(r.getFullYear(),r.getMonth()+1))},U=h=>{const l=new Date(r.getFullYear(),r.getMonth(),h),c=G(l,"yyyy-MM-dd");console.log(`Looking for profit for day ${h}, date string: ${c}`);const s=j.get(c);return console.log(`Profit found for day ${h}:`,s),s},E=h=>{const l=new Date(r.getFullYear(),r.getMonth(),h),c=new Date;if(c.setHours(0,0,0,0),!f()&&l.getTime()!==c.getTime()){const s=l<c?"Edição de dias passados disponível apenas no plano Medium ou superior. Faça upgrade para acessar esta funcionalidade.":"Edição de dias futuros disponível apenas no plano Medium ou superior. Faça upgrade para acessar esta funcionalidade.";b.error(s);return}d(l)};return e.jsxs(e.Fragment,{children:[e.jsxs(X,{className:"p-6 shadow-card",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h3",{className:"text-xl font-bold",children:[i[r.getMonth()]," ",r.getFullYear()]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(O,{variant:"outline",onClick:()=>{console.log("=== DEBUG INFO ==="),console.log("User ID:",g?.uid),console.log("Historical Summaries:",x),console.log("All Transactions:",v),console.log("Daily Profits Map:",Array.from(j.entries())),console.log("==================")},children:"Debug"}),e.jsx(O,{variant:"outline",size:"icon",onClick:M,children:e.jsx(Ce,{className:"h-4 w-4"})}),e.jsx(O,{variant:"outline",size:"icon",onClick:T,children:e.jsx(Me,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-7 gap-2",children:[["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"].map(h=>e.jsx("div",{className:"text-center text-sm font-semibold text-muted-foreground p-2",children:h},h)),Array.from({length:R}).map((h,l)=>e.jsx("div",{},`empty-${l}`)),Array.from({length:N}).map((h,l)=>{const c=l+1,s=U(c),u=new Date(r.getFullYear(),r.getMonth(),c),y=new Date;y.setHours(0,0,0,0);const w=u.getTime()===y.getTime(),F=u<y,I=u>y,m=!f()&&(F||I);return e.jsxs("button",{onClick:()=>E(c),className:`
                  min-h-[80px] p-3 rounded-lg border transition-all hover:shadow-md relative group
                  ${w?"border-primary border-2":"border-border"}
                  ${F&&s!==void 0?"bg-muted/50":"bg-card"}
                  hover:bg-accent
                `,children:[e.jsx("div",{className:"absolute top-2 right-2 text-lg font-bold text-primary group-hover:text-black transition-colors duration-200",children:c}),m&&e.jsx("div",{className:"absolute top-2 left-2",children:e.jsx(Te,{className:"h-3 w-3 text-muted-foreground"})}),s!==void 0&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full pt-4",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"BRL"}),e.jsxs("div",{className:`text-sm font-bold ${s>=0?"text-success":"text-destructive"}`,children:[s>=0?"+":"","R$ ",s.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]},c)})]})]}),e.jsx(he,{open:!!n,onOpenChange:h=>!h&&d(null),children:e.jsxs(ge,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(pe,{children:e.jsxs(fe,{children:["Transações - ",n?.toLocaleDateString("pt-BR",{day:"2-digit",month:"long",year:"numeric"})]})}),n&&e.jsx(ze,{date:n})]})})]})};class ${static startDailyClosureService(o){this.stopDailyClosureService();const n=this.getNextMidnightInSaoPaulo(),d=n.getTime()-new Date().getTime();console.log("🕛 Serviço de fechamento diário iniciado"),console.log(`📅 Próximo fechamento em: ${n.toLocaleString("pt-BR",{timeZone:"America/Sao_Paulo"})}`),this.closureInterval=setTimeout(()=>{this.processDailyClosure(o),this.closureInterval=setInterval(()=>{this.processDailyClosure(o)},24*60*60*1e3)},d)}static stopDailyClosureService(){this.closureInterval&&(clearTimeout(this.closureInterval),clearInterval(this.closureInterval),this.closureInterval=null,console.log("🛑 Serviço de fechamento diário parado"))}static async processManualClosure(o,n){const d=n||this.getCurrentDateInSaoPaulo();await this.processDailyClosure(o,d)}static async processDailyClosure(o,n){if(this.isProcessing){console.log("⚠️ Fechamento diário já está sendo processado");return}this.isProcessing=!0;const d=n||this.getCurrentDateInSaoPaulo();try{console.log(`🔄 Iniciando fechamento diário para ${d}`);const g=await He.getTransactionsByDateRange(o,d,d);if(g.length===0){console.log("📝 Nenhuma transação encontrada para o dia"),this.isProcessing=!1;return}const f=await this.calculateDailySummary(o,d,g),x=await this.getExistingSummary(o,d);x?(console.log("📝 Atualizando resumo existente"),await _.updateDailySummary(o,x.id,f)):(console.log("📝 Criando novo resumo diário"),await _.createDailySummary(o,f)),console.log(`✅ Fechamento diário concluído para ${d}`),console.log(`📊 Resumo: ${f.totalDeposits} depósitos, ${f.totalWithdraws} saques, ${f.totalProfit} lucro`)}catch(g){console.error("❌ Erro no fechamento diário:",g)}finally{this.isProcessing=!1}}static async calculateDailySummary(o,n,d){const g=d.filter(i=>i.type==="deposit").reduce((i,D)=>i+(D.amount||0),0),f=d.filter(i=>i.type==="withdraw").reduce((i,D)=>i+(D.amount||0),0),x=f-g,v=d.reduce((i,D)=>{const N=D.employeeId;return i[N]||(i[N]={employeeId:N,employeeName:"Funcionário não encontrado",deposits:0,withdraws:0,profit:0,transactionCount:0}),D.type==="deposit"?i[N].deposits+=D.amount||0:i[N].withdraws+=D.amount||0,i[N].transactionCount++,i},{});Object.values(v).forEach(i=>{i.profit=i.withdraws-i.deposits});const j=Object.values(v);return{date:n,totalDeposits:g,totalWithdraws:f,totalProfit:x,transactionCount:d.length,employeeSummaries:j}}static async getExistingSummary(o,n){try{return(await _.getDailySummaries(o)).find(g=>g.date===n)||null}catch(d){return console.error("Erro ao buscar resumo existente:",d),null}}static getNextMidnightInSaoPaulo(){const o=new Date,n=new Date(o.toLocaleString("en-US",{timeZone:"America/Sao_Paulo"})),d=new Date(n);return d.setDate(d.getDate()+1),d.setHours(0,0,0,0),new Date(d.toLocaleString("en-US",{timeZone:"UTC"}))}static getCurrentDateInSaoPaulo(){return new Date().toLocaleDateString("en-CA",{timeZone:"America/Sao_Paulo"})}static isServiceActive(){return this.closureInterval!==null}static getNextClosureInfo(){return{nextClosure:this.getNextMidnightInSaoPaulo(),isActive:this.isServiceActive()}}}Q($,"closureInterval",null),Q($,"isProcessing",!1);const _e=()=>{const{user:r}=W(),[o,n]=A.useState(!1),[d,g]=A.useState(null);return A.useEffect(()=>{if(r?.uid){console.log("🚀 Iniciando serviço de fechamento diário para usuário:",r.uid),$.startDailyClosureService(r.uid),n($.isServiceActive());const{nextClosure:j}=$.getNextClosureInfo();g(j);const i=setInterval(()=>{n($.isServiceActive());const{nextClosure:D}=$.getNextClosureInfo();g(D)},6e4);return()=>{clearInterval(i),$.stopDailyClosureService(),console.log("🛑 Serviço de fechamento diário parado")}}},[r?.uid]),{isServiceActive:o,nextClosure:d,processManualClosure:async j=>{if(!r?.uid){b.error("Usuário não autenticado");return}try{b.loading("Processando fechamento diário...",{id:"daily-closure"}),await $.processManualClosure(r.uid,j),b.success("Fechamento diário processado com sucesso!",{id:"daily-closure"})}catch(i){console.error("Erro no fechamento manual:",i),b.error("Erro ao processar fechamento diário",{id:"daily-closure"})}},stopService:()=>{$.stopDailyClosureService(),n(!1),g(null),b.info("Serviço de fechamento diário parado")},restartService:()=>{if(r?.uid){$.startDailyClosureService(r.uid),n($.isServiceActive());const{nextClosure:j}=$.getNextClosureInfo();g(j),b.success("Serviço de fechamento diário reiniciado")}}}},xt=()=>{const{user:r}=W(),o=Be();_e();const{data:n=[],isLoading:d,error:g}=qe(r?.uid||""),f=Ee(),x=new Date(B().getTime()-7*24*60*60*1e3).toISOString().split("T")[0],v=new Date(B().getFullYear(),B().getMonth(),1).toISOString().split("T")[0],j=new Date(B().getFullYear(),B().getMonth()+1,0).toISOString().split("T")[0],{data:i=[],isLoading:D,error:N}=Y(r?.uid||"",f,f),{data:R=[],isLoading:M}=Y(r?.uid||"",x,f),{data:T=[],isLoading:U}=Y(r?.uid||"",v,j),{data:E=[]}=ee(r?.uid||"");console.log("Dashboard Debug:",{user:r?.uid,employees:n.length,todayTransactions:i.length,today:f,employeesLoading:d,transactionsLoading:D,employeesError:g,transactionsError:N});const h=i?.filter(t=>t.type==="deposit")?.reduce((t,a)=>t+(a.amount||0),0)||0,c=(i?.filter(t=>t.type==="withdraw")?.reduce((t,a)=>t+(a.amount||0),0)||0)-h,s=n?.filter(t=>t.status==="active")||[];i?.length;const u=B().getFullYear(),y=B().getMonth(),w=E.filter(t=>{const a=new Date(t.date);return a.getFullYear()===u&&a.getMonth()===y}),F=w.reduce((t,a)=>t+(a.profit||a.margin||0),0),I=new Set(w.map(t=>t.date)),m=T.filter(t=>!I.has(t.date)),S=m.reduce((t,a)=>{const p=a.type==="withdraw"?a.amount:-a.amount;return t+p},0);console.log("Dashboard - Transações Abertas (não fechadas):",{totalMonthlyTransactions:T.length,closedDates:Array.from(I),openTransactions:m.length,monthlyRevenueFromTransactions:S});const L=F+S;console.log("Dashboard - Cálculo Receita Mensal:",{currentYear:u,currentMonth:y,monthlySummaries:w.length,monthlyRevenueFromSummaries:F,monthlyTransactions:T.length,monthlyRevenueFromTransactions:S,monthlyRevenue:L}),console.log("Dashboard - Fechamentos Diários Detalhados:"),w.forEach((t,a)=>{console.log(`  ${a+1}. Data: ${t.date}, Profit: ${t.profit||t.margin||0}`)}),console.log("Dashboard - Transações Abertas Detalhadas:"),m.forEach((t,a)=>{const p=t.type==="withdraw"?t.amount:-t.amount;console.log(`  ${a+1}. Data: ${t.date}, Tipo: ${t.type}, Valor: ${t.amount}, Profit: ${p}`)}),s.length*1e4;const xe=[{title:"Receita Hoje",value:`R$ ${c.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`,icon:re,valueColor:c>=0?"positive":"negative",clickable:!0,onClick:()=>o("/resumo-dia")},{title:"Receita do Mês",value:`R$ ${L.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`,icon:L>=0?J:Z,valueColor:L>=0?"positive":"negative",clickable:!0,onClick:()=>o("/relatorios")},{title:"Funcionários Ativos",value:s.length.toString(),icon:ne,valueColor:"default",clickable:!0,onClick:()=>o("/gestao-funcionarios")},{title:"Transações do Mês",value:T.length.toString(),icon:$e,valueColor:"default",clickable:!0,onClick:()=>{o("/relatorios"),setTimeout(()=>{const t=document.getElementById("weekly-chart-section");t&&t.scrollIntoView({behavior:"smooth",block:"start"})},500)}}];(()=>{const t=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"],a=[];for(let p=6;p>=0;p--){const C=new Date;C.setDate(C.getDate()-p);const k=C.toISOString().split("T")[0],ae=R.filter(P=>new Date(P.createdAt?.toDate?.()||P.createdAt).toISOString().split("T")[0]===k),H=ae.filter(P=>P.type==="withdraw").reduce((P,z)=>P+(Number(z.amount)||0),0),V=ae.filter(P=>P.type==="deposit").reduce((P,z)=>P+(Number(z.amount)||0),0),ve=a.length>0?a[a.length-1].lucroAcumulado+H-V:H-V;a.push({name:t[C.getDay()],receita:H,despesa:V,lucro:H-V,lucroAcumulado:ve,date:k,isToday:p===0})}return a})();const ye=()=>{const t=[];return R.sort((a,p)=>new Date(p.createdAt?.toDate?.()||p.createdAt).getTime()-new Date(a.createdAt?.toDate?.()||a.createdAt).getTime()).slice(0,5).forEach(a=>{const p=n.find(k=>k.id===a.employeeId),C=te(new Date(a.createdAt?.toDate?.()||a.createdAt));a.type==="withdraw"?t.push({id:`transaction-${a.id}`,action:"Pagamento recebido",employee:p?.name||"Funcionário não encontrado",value:`R$ ${Number(a.amount||0).toLocaleString("pt-BR")}`,time:C,type:"payment",icon:re}):a.type==="deposit"&&t.push({id:`transaction-${a.id}`,action:"Pagamento pendente",employee:p?.name||"Funcionário não encontrado",value:`R$ ${Number(a.amount||0).toLocaleString("pt-BR")}`,time:C,type:"pending",icon:Ae})}),n.sort((a,p)=>new Date(p.createdAt?.toDate?.()||p.createdAt).getTime()-new Date(a.createdAt?.toDate?.()||a.createdAt).getTime()).slice(0,2).forEach(a=>{const p=te(new Date(a.createdAt?.toDate?.()||a.createdAt));t.push({id:`employee-${a.id}`,action:"Novo funcionário",employee:a.name,value:"",time:p,type:"employee",icon:Ie})}),t.sort((a,p)=>{const C=se(a.time),k=se(p.time);return C-k}).slice(0,5)},te=t=>{const p=Math.floor((new Date-t)/(1e3*60));if(p<1)return"Agora mesmo";if(p<60)return`${p} min atrás`;const C=Math.floor(p/60);if(C<24)return`${C} hora${C>1?"s":""} atrás`;const k=Math.floor(C/24);return`${k} dia${k>1?"s":""} atrás`},se=t=>t==="Agora mesmo"?0:t.includes("min")?parseInt(t):t.includes("hora")?parseInt(t)*60:t.includes("dia")?parseInt(t)*24*60:999999,oe=ye();return e.jsx(Pe,{children:e.jsxs("div",{className:"space-y-8 animate-fade-in",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-4xl font-bold mb-2",children:"Dashboard"}),e.jsx("p",{className:"text-muted-foreground",children:"Visão geral do seu negócio"})]}),e.jsx("div",{className:"dashboard-grid",children:xe.map(t=>e.jsx(Re,{title:t.title,value:t.value,icon:t.icon,valueColor:t.valueColor,clickable:t.clickable,onClick:t.onClick},t.title))}),e.jsx(Ve,{}),e.jsx(Qe,{}),e.jsxs(X,{className:"p-6 shadow-card hover:shadow-glow transition-all duration-300",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Atividades Recentes"}),e.jsx("div",{className:"space-y-4",children:oe.length>0?oe.map(t=>{const a=t.icon;return e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("div",{className:`p-2 rounded-full ${t.type==="payment"?"bg-success/10":t.type==="pending"?"bg-warning/10":"bg-primary/10"}`,children:e.jsx(a,{className:`h-4 w-4 ${t.type==="payment"?"text-success":t.type==="pending"?"text-warning":"text-primary"}`})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:t.action}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.employee})]})]}),e.jsxs("div",{className:"text-right",children:[t.value&&e.jsx("p",{className:`font-semibold ${t.type==="payment"?"text-success":t.type==="pending"?"text-warning":"text-foreground"}`,children:t.value}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t.time})]})]},t.id)}):e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ne,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Nenhuma atividade recente"}),e.jsx("p",{className:"text-sm",children:"As atividades aparecerão aqui conforme você usa o sistema"})]})})]})]})})};export{xt as default};
