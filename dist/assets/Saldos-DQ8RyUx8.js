import{n as he,j as e,P as J,N as X,w as xe,p as fe,i as d}from"./ui-vendor-CYAqJ0RG.js";import{r as p}from"./react-vendor-a_rYd-gI.js";import{c as pe,b as ge,u as je,p as be,q as Ne,r as Ce,s as ye,d as ve,D as Pe,A as De,o as we,h as Ae,i as Se,j as Fe,k as Ee,l as Te,m as Be,n as ke}from"./DashboardLayout-B3XyjcMy.js";import{P as ze}from"./ProtectedPageContent-sbTILQdt.js";import{h as $e,j as Ie,B as u,C as Y}from"./index-LiAbW-2G.js";import{I as b}from"./input-J7GhaNSr.js";import{L as D}from"./label-DLesFRW0.js";import{D as I,a as q,b as M,c as L,d as O}from"./dialog-DkFBrAVQ.js";import"./user-specific.service-C1DLMu9g.js";import"./user-subcollections.service-B4HigrO8.js";import"./firebase-vendor-BUxvNq0f.js";import"./user-notifications.service-CAzP-qxP.js";import"./index-DMSHDzho.js";import"./proxy-C2pssEXW.js";import"./chart-vendor-ctXMAO2v.js";const ea=()=>{const R=he(),{user:i}=$e(),[h,T]=p.useState({name:"",color:"#FF5C00"}),[m,N]=p.useState(null),[Z,U]=p.useState(!1),[_,K]=p.useState(!1),[W,H]=p.useState(""),[B,Q]=p.useState(null),[g,w]=p.useState({}),{data:k=[]}=pe(i?.uid||""),{data:j=[]}=ge(i?.uid||""),{data:A=[]}=je(i?.uid||"","","");console.log("Saldos - Employees:",k.length),console.log("Saldos - Platforms:",j.length),console.log("Saldos - Transactions:",A.length),console.log("Saldos - All Transactions:",A),console.log("Saldos - Platforms IDs:",j.map(a=>({id:a.id,name:a.name}))),A.forEach((a,s)=>{console.log(`Transaction ${s}:`,{id:a.id,employeeId:a.employeeId,platformId:a.platformId,type:a.type,amount:a.amount,date:a.date})});const ee=be(),S=Ne(),ae=Ce(),z=ye(),se=ve(),C=(()=>{const a={};return k.forEach(s=>{a[s.id]={name:s.name,platforms:{},total:0},j.forEach(t=>{const r=A.filter(o=>o.employeeId===s.id&&o.platformId===t.id);console.log(`Debug - Employee: ${s.name}, Platform: ${t.name}, Transactions:`,r);const l=r.filter(o=>o.description&&o.description.includes("Ajuste manual de saldo"));if(l.length>0){const o=l.sort((x,f)=>{const y=x.createdAt?.toDate?.()?.getTime()||(x.createdAt?.seconds?x.createdAt.seconds*1e3:0)||x.updatedAt?.toDate?.()?.getTime()||0,v=f.createdAt?.toDate?.()?.getTime()||(f.createdAt?.seconds?f.createdAt.seconds*1e3:0)||f.updatedAt?.toDate?.()?.getTime()||0;if(y===0&&v===0){const E=new Date(x.date||0).getTime();return new Date(f.date||0).getTime()-E}return v-y})[0],c=Number(o.amount||0);a[s.id].platforms[t.id]=c,a[s.id].total+=c}else{const o=r.filter(n=>!n.description||!n.description.includes("Ajuste manual de saldo")),c=o.filter(n=>n.description&&n.description.startsWith("Surebet")),x=o.filter(n=>n.type==="deposit"&&(!n.description||!n.description.startsWith("Surebet"))),f=o.filter(n=>n.type==="withdraw"),y=c.reduce((n,P)=>n+Number(P.amount||0),0),v=x.reduce((n,P)=>n+Number(P.amount||0),0),E=f.reduce((n,P)=>n+Number(P.amount||0),0);console.log(`Debug - Deposits: ${v}, Withdraws: ${E}, Surebet: ${y}`);const $=E-v+y;a[s.id].platforms[t.id]=Math.max(0,$),a[s.id].total+=Math.max(0,$)}})}),Object.values(a)})();console.log("Saldos - Platform Balances:",C);const te=[...k].sort((a,s)=>a.name.localeCompare(s.name)),F=j.filter(a=>a.isActive!==!1),V=[...F.reduce((a,s)=>(a.find(r=>r.id===s.id||r.name===s.name)||a.push(s),a),[])].sort((a,s)=>{const t=C.reduce((l,o)=>l+(Number(o.platforms?.[a.id])||0),0),r=C.reduce((l,o)=>l+(Number(o.platforms?.[s.id])||0),0);return Number(r)-Number(t)}),re=C.reduce((a,s)=>a+(s.total||0),0),oe=j.filter(a=>a.name.toLowerCase().includes(W.toLowerCase())),ne=(a,s,t)=>{const r=`${a}-${s}`;w({...g,[r]:{employeeId:a,platformId:s,value:t.toString()}})},G=async(a,s)=>{const t=`${a}-${s}`,r=g[t];if(r)try{const l=Number(r.value),o={userId:i?.uid||"",employeeId:a,platformId:s,type:"deposit",amount:Math.abs(l),date:new Date().toISOString().split("T")[0],description:"Ajuste manual de saldo"};await se.mutateAsync(o),R.invalidateQueries({queryKey:["firebase-transactions"]}),await R.refetchQueries({queryKey:["firebase-transactions"]});const c={...g};delete c[t],w(c),d.success("Saldo atualizado!")}catch(l){console.error("Erro ao atualizar saldo:",l),d.error("Erro ao atualizar saldo")}},le=(a,s)=>{const t=`${a}-${s}`,r={...g};delete r[t],w(r)},ie=async()=>{if(i?.uid)try{await ee.mutateAsync({userId:i.uid,name:h.name,color:h.color}),d.success("Casa de aposta criada!"),T({name:"",color:"#FF5C00"}),U(!1)}catch{d.error("Erro ao criar casa de aposta")}},ce=async()=>{if(m)try{await S.mutateAsync({userId:i?.uid||"",id:m.id,data:{name:m.name,color:m.color}}),d.success("Casa de aposta atualizada!"),N(null)}catch{d.error("Erro ao atualizar casa de aposta")}},de=async a=>{try{await ae.mutateAsync({userId:i?.uid||"",id:a}),d.success("Casa de aposta excluída!")}catch{d.error("Erro ao excluir casa de aposta")}},me=async()=>{if(i?.uid)try{await z.mutateAsync(i.uid),d.success("Plataformas padrão criadas com sucesso!")}catch{d.error("Erro ao criar plataformas padrão")}},ue=async()=>{if(i?.uid)try{const a=[{name:"Pixbet",color:"#ADD8E6"},{name:"Betano",color:"#FF6600"},{name:"Mcgames",color:"#DC143C"},{name:"Kto",color:"#C80000"},{name:"Realsbet",color:"#00FFC8"},{name:"Vaidebet",color:"#FFD700"},{name:"Sportingbet",color:"#4682B4"},{name:"Superbet",color:"#FF3366"},{name:"Betao",color:"#FFA550"},{name:"Bet365",color:"#008040"},{name:"Esportivabet",color:"#FF8C00"},{name:"Hiperbet",color:"#DC0000"},{name:"Luvabet",color:"#ADFF2F"},{name:"Cassinopix",color:"#87CEEB"},{name:"Multibet",color:"#483D8B"}],s=j.map(t=>{const r=a.find(l=>l.name===t.name);return r&&t.color!==r.color?S.mutateAsync({userId:i.uid,id:t.id,data:{color:r.color}}):Promise.resolve()});await Promise.all(s),d.success("Cores das plataformas atualizadas!")}catch{d.error("Erro ao atualizar cores das plataformas")}};return e.jsx(Pe,{children:e.jsx(ze,{requiredFeature:"balances",featureName:"Saldos",requiredPlan:"Medium",children:e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(Ie,{className:"rounded-full bg-primary/10 px-4 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.35em] text-primary mb-4",children:"Saldos"}),e.jsx("h1",{className:"text-4xl font-bold mb-2",children:"Saldos"}),e.jsx("p",{className:"text-muted-foreground",children:"Gerencie contas e saldos por plataforma"})]}),e.jsxs("div",{className:"flex gap-2",children:[F.length===0&&e.jsxs(u,{onClick:me,disabled:z.isPending,className:"gap-2",children:[e.jsx(J,{className:"h-4 w-4"}),z.isPending?"Criando...":"Criar Plataformas Padrão"]}),F.length>0&&e.jsxs(u,{onClick:ue,disabled:S.isPending,variant:"outline",className:"gap-2",children:[e.jsx(X,{className:"h-4 w-4"}),S.isPending?"Atualizando...":"Atualizar Cores"]}),F.length>0&&e.jsxs(I,{open:_,onOpenChange:K,children:[e.jsx(q,{asChild:!0,children:e.jsxs(u,{variant:"outline",className:"gap-2",children:[e.jsx(xe,{className:"h-4 w-4"}),"Pesquisar Plataforma"]})}),e.jsxs(M,{children:[e.jsx(L,{children:e.jsx(O,{children:"Pesquisar Plataforma"})}),e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{children:[e.jsx(D,{children:"Nome da Plataforma"}),e.jsx(b,{placeholder:"Digite o nome da plataforma...",value:W,onChange:a=>H(a.target.value)})]}),e.jsx("div",{className:"max-h-60 overflow-y-auto",children:oe.map(a=>e.jsxs(u,{variant:"outline",className:"w-full justify-start mb-2",onClick:()=>{Q(a),K(!1),H("")},children:[e.jsx("div",{className:"w-4 h-4 rounded mr-2",style:{backgroundColor:a.color}}),a.name]},a.id))})]})]})]}),e.jsxs(I,{open:Z,onOpenChange:U,children:[e.jsx(q,{asChild:!0,children:e.jsxs(u,{variant:"outline",className:"gap-2",children:[e.jsx(J,{className:"h-4 w-4"}),"Criar Casa"]})}),e.jsxs(M,{children:[e.jsx(L,{children:e.jsx(O,{children:"Criar Casa de Aposta"})}),e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{children:[e.jsx(D,{children:"Nome"}),e.jsx(b,{value:h.name,onChange:a=>T({...h,name:a.target.value})})]}),e.jsxs("div",{children:[e.jsx(D,{children:"Cor"}),e.jsx(b,{type:"color",value:h.color,onChange:a=>T({...h,color:a.target.value})})]}),e.jsx(u,{className:"w-full",onClick:ie,disabled:!h.name.trim(),children:"Criar"})]})]})]})]})]}),e.jsxs(Y,{className:"p-6 shadow-card gradient-success",children:[e.jsx("p",{className:"text-sm text-success-foreground/80 mb-2",children:"Saldo Total"}),e.jsxs("p",{className:"text-4xl font-bold text-success-foreground",children:["R$ ",Number(re||0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs(Y,{className:"shadow-card overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Saldos por Plataforma"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Clique nos valores para editar. Os valores são salvos automaticamente ao sair do campo."}),B&&e.jsxs("div",{className:"mt-2 p-2 bg-muted rounded",children:[e.jsx("span",{className:"text-sm",children:"Filtrado por: "}),e.jsx("span",{className:"inline-block w-3 h-3 rounded mr-1",style:{backgroundColor:B.color}}),e.jsx("span",{className:"font-medium",children:B.name}),e.jsx(u,{variant:"ghost",size:"sm",onClick:()=>Q(null),className:"ml-2 h-6 px-2",children:"Limpar filtro"})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-muted/50",children:[e.jsx("th",{className:"text-left p-4 font-semibold sticky left-0 bg-background z-10",children:"Funcionário"}),e.jsx("th",{className:"text-center p-4 font-semibold sticky left-20 bg-background z-10",children:"Total por Funcionário"}),V.map(a=>e.jsx("th",{className:"text-center p-4 font-semibold min-w-[120px]",style:{backgroundColor:a.color+"20"},children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-white font-medium",children:a.name}),e.jsxs(I,{open:m?.id===a.id,onOpenChange:s=>!s&&N(null),children:[e.jsx(q,{asChild:!0,children:e.jsx(u,{size:"icon",variant:"ghost",className:"h-6 w-6 text-white hover:bg-white/20",onClick:()=>N(a),children:e.jsx(X,{className:"h-3 w-3"})})}),e.jsxs(M,{children:[e.jsx(L,{children:e.jsx(O,{children:"Editar Casa de Aposta"})}),e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{children:[e.jsx(D,{children:"Nome"}),e.jsx(b,{value:m?.name||"",onChange:s=>N({...m,name:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(D,{children:"Cor"}),e.jsx(b,{type:"color",value:m?.color||"#FF5C00",onChange:s=>N({...m,color:s.target.value})})]}),e.jsx(u,{className:"w-full",onClick:ce,disabled:!m?.name?.trim(),children:"Salvar"})]})]})]}),e.jsxs(De,{children:[e.jsx(we,{asChild:!0,children:e.jsx(u,{size:"icon",variant:"ghost",className:"h-6 w-6 text-white hover:bg-white/20",children:e.jsx(fe,{className:"h-3 w-3"})})}),e.jsxs(Ae,{children:[e.jsxs(Se,{children:[e.jsx(Fe,{children:"Excluir casa de aposta?"}),e.jsx(Ee,{children:"Esta ação não pode ser desfeita. Todas as transações relacionadas a esta plataforma serão mantidas."})]}),e.jsxs(Te,{children:[e.jsx(Be,{children:"Cancelar"}),e.jsx(ke,{onClick:()=>de(a.id),children:"Excluir"})]})]})]})]})},a.id))]})}),e.jsx("tbody",{children:te.map(a=>{const s=C.find(t=>t.name===a.name);return e.jsxs("tr",{className:"border-t hover:bg-muted/30",children:[e.jsx("td",{className:"p-4 font-medium sticky left-0 bg-background z-10",children:a.name}),e.jsx("td",{className:"p-4 text-center font-bold sticky left-20 bg-background z-10",children:e.jsxs("span",{className:"text-success",children:["R$ ",(s?.total||0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})]})}),V.map(t=>{const r=`${a.id}-${t.id}`,l=g[r],o=s?.platforms?.[t.id]||0;return e.jsx("td",{className:"p-4 text-center",children:l?e.jsx("div",{className:"flex items-center gap-1",children:e.jsx(b,{type:"number",value:l.value,onChange:c=>w({...g,[r]:{...l,value:c.target.value}}),className:"w-20 h-8 text-center",onKeyDown:c=>{c.key==="Enter"?G(a.id,t.id):c.key==="Escape"&&le(a.id,t.id)},onBlur:()=>G(a.id,t.id),autoFocus:!0})}):e.jsxs("span",{className:"text-success cursor-pointer hover:bg-muted/50 p-1 rounded",onClick:()=>ne(a.id,t.id,o),children:["R$ ",o.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})]})},t.id)})]},a.id)})})]})})]})]})})})};export{ea as default};
