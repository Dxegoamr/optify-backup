import{j as e,a6 as de,a as v,a7 as me,i as o,p as Q}from"./ui-vendor-CYAqJ0RG.js";import{u as ue,r as i}from"./react-vendor-a_rYd-gI.js";import{D as xe,A as he,o as pe,h as fe,i as ge,j as je,k as ve,l as Ne,m as be,n as Pe}from"./DashboardLayout-B3XyjcMy.js";import{h as ye,j as w,C as N,B as u,U as M,x as Ce}from"./index-LiAbW-2G.js";import{L as b}from"./label-DLesFRW0.js";import{I as P}from"./input-J7GhaNSr.js";import{H as we,T as De}from"./firebase-vendor-BUxvNq0f.js";import{d as Se}from"./user-subcollections.service-B4HigrO8.js";import{g as Ae}from"./plan-transactions.service-Bz7_vpVn.js";import{P as Fe}from"./plans.service-CGbKSRdJ.js";import"./user-specific.service-C1DLMu9g.js";import"./user-notifications.service-CAzP-qxP.js";import"./index-DMSHDzho.js";import"./chart-vendor-ctXMAO2v.js";const Ge=()=>{const{user:n}=ye(),D=ue(),[S,A]=i.useState(""),[W,F]=i.useState(!1),[$,I]=i.useState(!1),[x,O]=i.useState(null),[h,R]=i.useState([]),[B,U]=i.useState(null),[m,E]=i.useState(!0),[c,y]=i.useState(1),L=10,[g,V]=i.useState(""),[H,G]=i.useState(""),[_,q]=i.useState(""),[j,J]=i.useState(!1),X=async()=>{if(!n?.uid){o.error("UsuÃ¡rio nÃ£o autenticado");return}if(!g.trim()){o.error("O nome completo Ã© obrigatÃ³rio");return}try{J(!0),await M.updateUserPersonalInfo(n.uid,{name:g.trim(),displayName:g.trim(),phone:H.trim()||void 0,cpf:_.trim()||void 0});const a=await M.getUserProfile(n.uid);O(a),o.success("Perfil atualizado com sucesso!")}catch(a){console.error("Erro ao salvar informaÃ§Ãµes pessoais:",a),o.error("Erro ao salvar informaÃ§Ãµes. Tente novamente.")}finally{J(!1)}},Y=async()=>{if(S.toLowerCase()!=="sim"){o.error('Digite "sim" para confirmar a exclusÃ£o');return}try{const a=Ce.currentUser,r=a?.uid;if(!a||!r){o.error("UsuÃ¡rio nÃ£o autenticado");return}await Se(r),await we(a),o.success("Conta excluÃ­da com sucesso"),F(!1),A(""),D("/")}catch(a){a?.code==="auth/requires-recent-login"?o.error("Por seguranÃ§a, faÃ§a login novamente e tente excluir a conta."):o.error("NÃ£o foi possÃ­vel excluir a conta. Tente novamente.")}},ee=()=>{F(!0),A("")},ae=async a=>{const r={standard:34.9,medium:49.9,ultimate:74.9,free:0};if(!a||a==="free")return 0;const s=a.toLowerCase().trim();try{let t=[];try{t=await Fe.listActivePlans()}catch(d){if(d?.code==="failed-precondition"||d?.message?.includes("index"))console.warn("âš ï¸ Ãndice do Firestore para plans ainda nÃ£o estÃ¡ pronto, usando valores padrÃ£o");else throw d}const l=t.find(d=>{const C=d.id.toLowerCase()===s,le=d.value?.toLowerCase()===s,T=d.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s-]/g,"").trim(),ce=T===s||T.includes(s)||s.includes(T);return C||le||ce});if(l&&typeof l.price=="number")return console.log(`âœ… PreÃ§o do plano encontrado na coleÃ§Ã£o plans: R$ ${l.price}`),l.price;const p=r[s];return p!==void 0?(console.log(`âš ï¸ Plano nÃ£o encontrado na coleÃ§Ã£o plans, usando preÃ§o padrÃ£o: R$ ${p}`),p):(console.warn(`âš ï¸ Plano "${a}" nÃ£o encontrado e sem preÃ§o padrÃ£o definido`),null)}catch(t){console.error("âŒ Erro ao buscar preÃ§o do plano do Firestore:",t);const l=r[s];return l!==void 0?(console.log(`ðŸ“‹ Usando preÃ§o padrÃ£o devido ao erro: R$ ${l}`),l):null}};i.useEffect(()=>{let a=!0;return(async()=>{if(!n?.uid){a&&E(!1);return}try{a&&E(!0);const s=await M.getUserProfile(n.uid);if(!a)return;O(s),s&&(V(s.name||n?.displayName||""),G(s.phone||""),q(s.cpf||s.cnpj||""));try{const t=await Ae(n.uid);a&&(R(t),y(1))}catch(t){t?.code==="failed-precondition"||t?.message?.includes("index")?console.warn("âš ï¸ Ãndice do Firestore para transactions_plans ainda nÃ£o estÃ¡ pronto"):console.warn("âš ï¸ Erro ao buscar histÃ³rico de pagamentos:",t),a&&R([])}if(s?.plano)try{const t=await ae(s.plano);a&&U(t)}catch(t){if(console.error("Erro ao buscar preÃ§o do plano:",t),a){const l={standard:34.9,medium:49.9,ultimate:74.9,free:0},p=s.plano.toLowerCase().trim();U(l[p]??null)}}else a&&U(0)}catch(s){console.error("Erro ao carregar dados do perfil:",s),a&&o.error("Erro ao carregar informaÃ§Ãµes do perfil")}finally{a&&E(!1)}})(),()=>{a=!1}},[n?.uid]);const se=async()=>{if(!n?.email){o.error("NÃ£o foi possÃ­vel identificar seu e-mail. FaÃ§a login novamente.");return}try{I(!0);const a="optify-definitivo",s=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?`http://localhost:5001/${a}/southamerica-east1/mpCreatePreference`:`https://southamerica-east1-${a}.cloudfunctions.net/mpCreatePreference`,l={plano:(x?.plano||"standard").toString().toLowerCase(),periodo:"mensal",email:n.email},p=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}),d=await p.json();if(!p.ok){o.error("Falha ao criar preferÃªncia de pagamento.");return}const C=d.initPoint||d.init_point||d.sandboxInitPoint;C?window.location.href=C:o.error("Link de pagamento nÃ£o retornado.")}catch{o.error("Erro ao iniciar assinatura.")}finally{I(!1)}},Z=a=>{if(!a)return null;try{let r;if(a instanceof De)r=a.toDate();else if(a.toDate&&typeof a.toDate=="function")r=a.toDate();else if(a instanceof Date)r=a;else if(typeof a=="string"||typeof a=="number")r=new Date(a);else return null;return r.toLocaleDateString("pt-BR")}catch(r){return console.error("Erro ao formatar data:",r),null}},k=a=>a?{free:"Free",standard:"Standard",medium:"Medium",ultimate:"Ultimate"}[a.toLowerCase()]||a.charAt(0).toUpperCase()+a.slice(1):"Free",re=a=>{const s={completed:{label:"Pago",variant:"default"},paid:{label:"Pago",variant:"default"},pending:{label:"Pendente",variant:"secondary"},failed:{label:"Falhou",variant:"destructive"},refunded:{label:"Reembolsado",variant:"outline"}}[a.toLowerCase()]||{label:a,variant:"outline"};return e.jsx(w,{variant:s.variant,children:s.label})},f=Math.ceil(h.length/L),z=(c-1)*L,K=z+L,te=h.slice(z,K),oe=()=>{c>1&&y(c-1)},ne=()=>{c<f&&y(c+1)},ie=a=>{y(a)};return e.jsx(xe,{children:e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsxs("div",{children:[e.jsx(w,{className:"rounded-full bg-primary/10 px-4 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.35em] text-primary mb-4",children:"Perfil"}),e.jsx("h1",{className:"text-4xl font-bold mb-2",children:"Meu Perfil"}),e.jsx("p",{className:"text-muted-foreground",children:"Gerencie suas informaÃ§Ãµes pessoais"})]}),e.jsx(N,{className:"p-6 shadow-card",children:e.jsxs("div",{className:"flex items-start gap-6",children:[e.jsx("div",{className:"p-4 bg-primary/10 rounded-full",children:e.jsx(de,{className:"h-16 w-16 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("h2",{className:"text-2xl font-bold",children:x?.name||n?.displayName||n?.email?.split("@")[0]||"UsuÃ¡rio"}),e.jsx(w,{variant:"default",className:"capitalize",children:k(x?.plano)}),x?.isAdmin&&e.jsx(w,{variant:"secondary",children:"Admin"})]}),e.jsx("p",{className:"text-muted-foreground mb-4",children:n?.email}),e.jsx(u,{variant:"outline",size:"sm",onClick:()=>D("/planos"),children:"Gerenciar Plano"})]})]})}),e.jsxs(N,{className:"p-6 shadow-card",children:[e.jsx("h3",{className:"text-lg font-semibold mb-6",children:"InformaÃ§Ãµes Pessoais"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"name",children:"Nome Completo"}),e.jsx(P,{id:"name",value:g,onChange:a=>V(a.target.value),placeholder:"Seu nome completo",disabled:m||j})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"email",children:"Email"}),e.jsx(P,{id:"email",type:"email",value:n?.email||"",disabled:!0,className:"bg-muted cursor-not-allowed"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"O email nÃ£o pode ser alterado"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"phone",children:"Telefone"}),e.jsx(P,{id:"phone",type:"tel",value:H,onChange:a=>G(a.target.value),placeholder:"(11) 99999-9999",disabled:m||j})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"cpf",children:"CPF/CNPJ"}),e.jsx(P,{id:"cpf",value:_,onChange:a=>q(a.target.value),placeholder:"000.000.000-00 ou 00.000.000/0000-00",disabled:m||j})]})]}),e.jsx("div",{className:"flex justify-end mt-6",children:e.jsx(u,{onClick:X,disabled:m||j||!g.trim(),children:j?e.jsxs(e.Fragment,{children:[e.jsx(v,{className:"mr-2 h-4 w-4 animate-spin"}),"Salvando..."]}):"Salvar AlteraÃ§Ãµes"})})]}),e.jsxs(N,{className:"p-6 shadow-card",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx(me,{className:"h-5 w-5 text-primary"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Plano Atual"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Plano"}),m?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Carregando..."})]}):e.jsx("p",{className:"text-xl font-bold capitalize",children:k(x?.plano)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"PrÃ³ximo Pagamento"}),m?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Carregando..."})]}):e.jsx("p",{className:"text-xl font-bold",children:x?.subscriptionEndDate&&Z(x.subscriptionEndDate)||"NÃ£o definido"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Valor Mensal"}),m?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Carregando..."})]}):e.jsx("p",{className:"text-xl font-bold",children:x?.plano==="free"?"GrÃ¡tis":B?`R$ ${B.toFixed(2).replace(".",",")}`:"NÃ£o disponÃ­vel"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{variant:"outline",onClick:()=>D("/planos"),children:"Alterar Plano"}),e.jsx(u,{onClick:se,disabled:$,children:$?"Redirecionando...":"Assinar Plano"})]})]}),e.jsxs(N,{className:"shadow-card",children:[e.jsx("div",{className:"p-6 border-b border-border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"HistÃ³rico de Pagamentos"}),!m&&h.length>0&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Total: ",h.length," ",h.length===1?"pagamento":"pagamentos"]})]})}),m?e.jsxs("div",{className:"p-6 flex items-center justify-center",children:[e.jsx(v,{className:"h-6 w-6 animate-spin text-muted-foreground"}),e.jsx("span",{className:"ml-2 text-muted-foreground",children:"Carregando histÃ³rico..."})]}):h.length===0?e.jsx("div",{className:"p-6 text-center text-muted-foreground",children:e.jsx("p",{children:"Nenhum pagamento encontrado no histÃ³rico."})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-muted/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left p-4 font-semibold",children:"Data"}),e.jsx("th",{className:"text-left p-4 font-semibold",children:"Plano"}),e.jsx("th",{className:"text-left p-4 font-semibold",children:"Valor"}),e.jsx("th",{className:"text-left p-4 font-semibold",children:"Status"}),e.jsx("th",{className:"text-left p-4 font-semibold",children:"Nota Fiscal"})]})}),e.jsx("tbody",{children:te.map(a=>e.jsxs("tr",{className:"border-t border-border hover:bg-muted/30 transition-colors",children:[e.jsx("td",{className:"p-4 text-sm text-muted-foreground",children:Z(a.createdAt)||"Data nÃ£o disponÃ­vel"}),e.jsx("td",{className:"p-4",children:k(a.planId)||a.planName}),e.jsxs("td",{className:"p-4 font-semibold",children:["R$ ",a.amount.toFixed(2).replace(".",",")]}),e.jsx("td",{className:"p-4",children:re(a.status)}),e.jsx("td",{className:"p-4",children:e.jsx(u,{variant:"ghost",size:"sm",onClick:()=>{o.info("Funcionalidade de download de nota fiscal em breve")},children:"Download"})})]},a.id))})]})}),f>1&&e.jsx("div",{className:"p-6 border-t border-border",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Mostrando ",z+1," a ",Math.min(K,h.length)," de ",h.length," pagamentos"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{variant:"outline",size:"sm",onClick:oe,disabled:c===1,children:"Anterior"}),e.jsx("div",{className:"flex items-center gap-1",children:Array.from({length:Math.min(5,f)},(a,r)=>{let s;return f<=5||c<=3?s=r+1:c>=f-2?s=f-4+r:s=c-2+r,e.jsx(u,{variant:c===s?"default":"outline",size:"sm",onClick:()=>ie(s),className:"min-w-[2.5rem]",children:s},s)})}),e.jsx(u,{variant:"outline",size:"sm",onClick:ne,disabled:c===f,children:"PrÃ³xima"})]})]})})]})]}),e.jsxs(N,{className:"p-6 shadow-card border-destructive/50",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx(Q,{className:"h-5 w-5 text-destructive"}),e.jsx("h3",{className:"text-lg font-semibold text-destructive",children:"Zona de Perigo"})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Uma vez que vocÃª exclua sua conta, nÃ£o hÃ¡ como voltar atrÃ¡s. Por favor, tenha certeza."}),e.jsxs(he,{open:W,onOpenChange:F,children:[e.jsx(pe,{asChild:!0,children:e.jsx(u,{variant:"destructive",onClick:ee,children:"Excluir Conta"})}),e.jsxs(fe,{className:"bg-card border-border",children:[e.jsxs(ge,{children:[e.jsxs(je,{className:"text-foreground flex items-center gap-2",children:[e.jsx(Q,{className:"w-5 h-5 text-destructive"}),"Confirmar ExclusÃ£o de Conta"]}),e.jsxs(ve,{className:"text-muted-foreground",children:["Esta aÃ§Ã£o Ã© ",e.jsx("strong",{children:"irreversÃ­vel"}),". Todos os seus dados serÃ£o permanentemente excluÃ­dos."]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg",children:[e.jsx("p",{className:"text-sm text-destructive font-medium mb-2",children:"âš ï¸ AtenÃ§Ã£o: Esta aÃ§Ã£o nÃ£o pode ser desfeita"}),e.jsxs("ul",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsx("li",{children:"â€¢ Todos os seus dados serÃ£o excluÃ­dos permanentemente"}),e.jsx("li",{children:"â€¢ Seu histÃ³rico de transaÃ§Ãµes serÃ¡ perdido"}),e.jsx("li",{children:"â€¢ Suas configuraÃ§Ãµes serÃ£o removidas"}),e.jsx("li",{children:"â€¢ VocÃª precisarÃ¡ criar uma nova conta para usar o sistema"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(b,{htmlFor:"deleteConfirmation",className:"text-sm font-medium text-foreground",children:["Para confirmar, digite ",e.jsx("strong",{children:'"sim"'})," abaixo:"]}),e.jsx(P,{id:"deleteConfirmation",type:"text",placeholder:"Digite 'sim' para confirmar",value:S,onChange:a=>A(a.target.value),className:"border-destructive/50 focus:border-destructive"})]})]}),e.jsxs(Ne,{children:[e.jsx(be,{className:"bg-muted hover:bg-muted/80 text-foreground border-border",children:"Cancelar"}),e.jsx(Pe,{onClick:Y,disabled:S.toLowerCase()!=="sim",className:"bg-destructive hover:bg-destructive/90 text-destructive-foreground disabled:opacity-50 disabled:cursor-not-allowed",children:"Excluir Conta Permanentemente"})]})]})]})]})]})})};export{Ge as default};
