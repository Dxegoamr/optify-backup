var Fe=Object.defineProperty;var Me=(r,a,n)=>a in r?Fe(r,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[a]=n;var oe=(r,a,n)=>Me(r,typeof a!="symbol"?a+"":a,n);import{n as Te,u as Ae,j as e,l as he,i as M,o as ie,e as ne,p as Ie,q as Re,r as Pe,L as $e,D as pe,U as ge,F as ke,s as Ee,t as Le}from"./ui-vendor-CYAqJ0RG.js";import{u as V,a as de,b as Be,c as ye,d as We,e as Oe,D as Ye}from"./DashboardLayout-B3XyjcMy.js";import{S as Ue}from"./stat-card-C7l8FUvR.js";import{h as Z,C as ue,B as _,i as ve,j as je,k as G,l as De}from"./index-LiAbW-2G.js";import{r as T,R as qe,u as Ge}from"./react-vendor-a_rYd-gI.js";import{D as we,a as ze,b as Se,c as Ne,d as be}from"./dialog-DkFBrAVQ.js";import{I as le}from"./input-J7GhaNSr.js";import{L as z}from"./label-DLesFRW0.js";import{U as xe,b as Ve,c as re}from"./user-specific.service-C1DLMu9g.js";import{shouldDisplayAsPositive as fe,isSameDate as H,calculateProfit as ce}from"./financial-calculations-dg7KAW8P.js";import{S as ee,a as te,b as se,c as ae,d as q}from"./select-Bd9uzrFY.js";import{f as Q}from"./format-G_C_Ywev.js";import{p as _e}from"./pt-BR-Crt2EcWv.js";import"./user-notifications.service-CAzP-qxP.js";import"./firebase-vendor-BUxvNq0f.js";import"./index-DMSHDzho.js";import"./chart-vendor-ctXMAO2v.js";import"./user-subcollections.service-B4HigrO8.js";import"./index-CdAzXW5_.js";import"./en-US-xOTpc2KN.js";const He=()=>{const r=Te(),{user:a}=Z(),[n,i]=T.useState(""),[y,g]=T.useState(!1),{data:S}=Ae({queryKey:["user-config",a?.uid],queryFn:async()=>a?.uid?xe.getUserConfig(a.uid):null,enabled:!!a?.uid}),[b,N]=T.useState(S?.monthlyGoal||1e4);qe.useEffect(()=>{S?.monthlyGoal&&N(S.monthlyGoal)},[S]);const w=new Date,P=new Date(w.getFullYear(),w.getMonth(),1),E=new Date(w.getFullYear(),w.getMonth()+1,0),$=P.toISOString().split("T")[0],l=E.toISOString().split("T")[0],{data:v=[]}=V(a?.uid||"",$,l),{data:C=[]}=de(a?.uid||""),k=w.getFullYear(),x=w.getMonth(),d=C.filter(m=>{const j=new Date(m.date);return j.getFullYear()===k&&j.getMonth()===x}),f=d.reduce((m,j)=>m+(j.profit||j.margin||0),0),u=new Set(d.map(m=>m.date)),c=v.filter(m=>{const j=m.date;return!(u.has(j)||m.description&&m.description.startsWith("FreeBet")&&d.find(W=>W.date===j)||m.description&&m.description.startsWith("Surebet")&&d.find(W=>W.date===j))}).reduce((m,j)=>{const t=j.description&&j.description.startsWith("Surebet");let p;return t?p=j.amount:p=j.type==="withdraw"?j.amount:-j.amount,m+p},0),F=f+c,Y=async()=>{const m=Number(n);if(m<=0){M.error("A meta deve ser maior que zero");return}try{a?.uid&&await xe.updateMonthlyGoal(a.uid,m),N(m),M.success("Meta atualizada!"),g(!1),i(""),r.invalidateQueries({queryKey:["user-config",a?.uid]})}catch(j){console.error("Erro ao atualizar meta:",j),M.error("Erro ao atualizar meta. Tente novamente.")}},L=b>0?Math.min(F/b*100,100):0;return e.jsxs(ue,{className:"p-4 lg:p-6 shadow-card hover:shadow-glow transition-all duration-300 relative overflow-hidden group",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-transparent via-transparent to-primary/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none"}),e.jsxs("div",{className:"flex items-center justify-between mb-4 relative z-10",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"text-sm text-muted-foreground mb-1 flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4 text-primary"}),"Meta Mensal"]}),e.jsxs("p",{className:"text-2xl lg:text-3xl font-bold leading-tight flex items-baseline gap-2",children:["R$ ",b.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2}),e.jsx("span",{className:"text-xs font-normal text-muted-foreground",children:"objetivo"})]})]}),e.jsxs(we,{open:y,onOpenChange:g,children:[e.jsx(ze,{asChild:!0,children:e.jsxs("button",{className:"p-3 lg:p-4 bg-gradient-primary rounded-xl shadow-glow hover:shadow-glow-lg transition-all duration-300 cursor-pointer flex-shrink-0 ml-4 group/btn relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-white/20 translate-y-full group-hover/btn:translate-y-0 transition-transform duration-300"}),e.jsx(he,{className:"h-5 w-5 lg:h-6 lg:w-6 text-primary-foreground relative z-10"})]})}),e.jsxs(Se,{children:[e.jsx(Ne,{children:e.jsx(be,{children:"Alterar Meta Mensal"})}),e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{children:[e.jsx(z,{children:"Nova Meta (R$)"}),e.jsx(le,{type:"number",step:"0.01",placeholder:"0,00",value:n,onChange:m=>i(m.target.value)})]}),e.jsx(_,{className:"w-full",onClick:Y,children:"Salvar Meta"})]})]})]})]}),e.jsxs("div",{className:"space-y-3 mb-4 relative z-10",children:[e.jsxs("div",{className:"flex justify-between text-sm items-end",children:[e.jsx("span",{className:"text-muted-foreground",children:"Progresso Atual"}),e.jsx("div",{className:"text-right",children:e.jsxs("span",{className:"font-bold text-primary text-lg",children:[L.toFixed(1),"%"]})})]}),e.jsxs("div",{className:"relative w-full h-4 bg-muted/50 rounded-full overflow-hidden border border-border/50",children:[e.jsx("div",{className:"absolute top-0 left-0 h-full gradient-primary transition-all duration-1000 ease-out rounded-full shadow-[0_0_10px_rgba(255,165,0,0.5)]",style:{width:`${Math.min(L,100)}%`,minWidth:L>0?"2px":"0px"},children:e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-[shimmer_2s_infinite] -skew-x-12"})}),L>100&&e.jsx("div",{className:"absolute top-0 left-0 h-full gradient-success transition-all duration-1000 ease-out rounded-full w-full opacity-50"})]}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground mt-2",children:[e.jsxs("span",{children:["R$ ",F.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})," alcanÃ§ados"]}),e.jsxs("span",{children:["Faltam R$ ",Math.max(0,b-F).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]})]})},Qe=({date:r})=>{const{user:a}=Z(),{getAllowedEmployees:n}=ve(),[i,y]=T.useState(""),[g,S]=T.useState(""),[b,N]=T.useState("none"),[w,P]=T.useState("none"),[E,$]=T.useState("none"),[l,v]=T.useState("none"),C=Q(r,"yyyy-MM-dd"),{data:k=[]}=Be(a?.uid||""),{data:x=[]}=ye(a?.uid||""),d=n(x),{data:f=[]}=V(a?.uid||""),u=f.filter(t=>t.date===C),h=We(),c=Oe(),F=async(t,p,I,W)=>{if(!a?.uid||!p){M.error("Preencha o valor da transaÃ§Ã£o");return}try{const U={userId:a.uid,employeeId:W==="none"?"":W||"",platformId:I==="none"?"":I||"",type:t,amount:Number(p),date:C},s=await h.mutateAsync(U);M.success(`${t==="deposit"?"DepÃ³sito":"Saque"} registrado com sucesso!`),t==="deposit"?(y(""),N("none"),$("none")):(S(""),P("none"),v("none"))}catch(U){console.error("Erro ao criar transaÃ§Ã£o:",U),console.error("Error details:",U),M.error("Erro ao registrar transaÃ§Ã£o: "+U.message)}},Y=async t=>{try{await c.mutateAsync(t),M.success("TransaÃ§Ã£o excluÃ­da com sucesso!")}catch(p){console.error("Erro ao excluir transaÃ§Ã£o:",p),M.error("Erro ao excluir transaÃ§Ã£o")}},L=t=>t&&k.find(I=>I.id===t)?.name||"N/A",m=t=>k.find(I=>I.id===t)?.color||"#666",j=t=>t&&d.find(I=>I.id===t)?.name||"N/A";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-2xl font-bold mb-2",children:["TransaÃ§Ãµes - ",Q(r,"dd 'de' MMMM 'de' yyyy",{locale:_e})]}),e.jsx("p",{className:"text-muted-foreground",children:"Gerencie as movimentaÃ§Ãµes deste dia"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-5 w-5 text-destructive"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Registrar DepÃ³sito"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"deposit-amount",children:"Valor (R$)"}),e.jsx(le,{id:"deposit-amount",type:"number",step:"0.01",placeholder:"0,00",value:i,onChange:t=>y(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"deposit-platform",children:"Plataforma (opcional)"}),e.jsxs(ee,{value:b,onValueChange:N,children:[e.jsx(te,{children:e.jsx(se,{placeholder:"Selecione uma plataforma..."})}),e.jsxs(ae,{children:[e.jsx(q,{value:"none",children:"Nenhuma plataforma"}),k.map(t=>e.jsx(q,{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"deposit-employee",children:"FuncionÃ¡rio (opcional)"}),e.jsxs(ee,{value:E,onValueChange:$,children:[e.jsx(te,{children:e.jsx(se,{placeholder:"Selecione um funcionÃ¡rio..."})}),e.jsxs(ae,{children:[e.jsx(q,{value:"none",children:"Nenhum funcionÃ¡rio"}),d.map(t=>e.jsx(q,{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs(_,{onClick:()=>F("deposit",i,b,E),className:"w-full gap-2",disabled:!i||h.isPending,children:[e.jsx(ie,{className:"h-4 w-4"}),"Registrar DepÃ³sito"]})]}),e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-5 w-5 text-success"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Registrar Saque"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"withdraw-amount",children:"Valor (R$)"}),e.jsx(le,{id:"withdraw-amount",type:"number",step:"0.01",placeholder:"0,00",value:g,onChange:t=>S(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"withdraw-platform",children:"Plataforma (opcional)"}),e.jsxs(ee,{value:w,onValueChange:P,children:[e.jsx(te,{children:e.jsx(se,{placeholder:"Selecione uma plataforma..."})}),e.jsxs(ae,{children:[e.jsx(q,{value:"none",children:"Nenhuma plataforma"}),k.map(t=>e.jsx(q,{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"withdraw-employee",children:"FuncionÃ¡rio (opcional)"}),e.jsxs(ee,{value:l,onValueChange:v,children:[e.jsx(te,{children:e.jsx(se,{placeholder:"Selecione um funcionÃ¡rio..."})}),e.jsxs(ae,{children:[e.jsx(q,{value:"none",children:"Nenhum funcionÃ¡rio"}),d.map(t=>e.jsx(q,{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs(_,{onClick:()=>F("withdraw",g,w,l),className:"w-full gap-2",disabled:!g||h.isPending,children:[e.jsx(ne,{className:"h-4 w-4"}),"Registrar Saque"]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"TransaÃ§Ãµes do Dia"}),u.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Nenhuma transaÃ§Ã£o registrada para este dia"}):e.jsx("div",{className:"space-y-2",children:u.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-accent/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(je,{variant:t.type==="withdraw"?"default":"destructive",style:{backgroundColor:t.description?t.description.startsWith("Surebet")?"#86efac":t.type==="withdraw"?"#10b981":"#ef4444":m(t.platformId)},children:t.description&&t.description.startsWith("FreeBet")?t.description.split(" ")[0]:t.description&&t.description.startsWith("Surebet")?"Surebet":t.type==="deposit"?"DepÃ³sito":"Saque"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.description||L(t.platformId)}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[j(t.employeeId)!=="N/A"&&e.jsxs("span",{className:"block",children:["FuncionÃ¡rio: ",j(t.employeeId)]}),e.jsx("span",{children:Q(new Date(t.createdAt?.toDate?.()||t.date),"HH:mm")})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:`font-bold ${fe(t)?"text-success":"text-destructive"}`,children:[fe(t)?"+":"-","R$ ",Number(t.amount).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx(_,{variant:"ghost",size:"icon",onClick:()=>Y(t.id),className:"text-destructive hover:text-destructive",children:e.jsx(Ie,{className:"h-4 w-4"})})]})]},t.id))})]}),u.length>0&&e.jsxs("div",{className:"p-4 bg-muted/50 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Resumo do Dia"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"DepÃ³sitos"}),e.jsxs("div",{className:"font-bold text-foreground",children:["R$ ",u.filter(t=>t.type==="deposit").reduce((t,p)=>t+Number(p.amount),0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Saques"}),e.jsxs("div",{className:"font-bold text-foreground",children:["R$ ",u.filter(t=>t.type==="withdraw").reduce((t,p)=>t+Number(p.amount),0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Lucro"}),e.jsxs("div",{className:`font-bold ${u.reduce((t,p)=>t+(p.type==="withdraw"?p.amount:-p.amount),0)>=0?"text-success":"text-destructive"}`,children:["R$ ",u.reduce((t,p)=>t+(p.type==="withdraw"?p.amount:-p.amount),0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]})]})]})},Ze=()=>{const[r,a]=T.useState(G()),[n,i]=T.useState(null),{user:y}=Z(),{canEditPreviousCalendarDays:g}=ve(),{data:S=[]}=de(y?.uid||""),{data:b=[]}=V(y?.uid||""),N=T.useMemo(()=>{const x=new Map,d=new Set,f=De();S.forEach(h=>{let c;typeof h.date=="string"?c=h.date:h.date&&h.date.toDate?c=Q(h.date.toDate(),"yyyy-MM-dd"):c=Q(new Date(h.date),"yyyy-MM-dd"),!H(c,f)&&(d.add(c),x.set(c,h.profit||h.margin||0))});const u=new Map;return b.forEach(h=>{const c=h.date;d.has(c)&&!H(c,f)||(u.has(c)||u.set(c,[]),u.get(c).push(h))}),u.forEach((h,c)=>{const F=ce(h);H(c,f)?x.set(c,F):d.has(c)||x.set(c,F)}),x},[S,b]),w=["Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"],P=x=>{const d=x.getFullYear(),f=x.getMonth(),u=new Date(d,f,1),c=new Date(d,f+1,0).getDate(),F=u.getDay();return{daysInMonth:c,startingDayOfWeek:F}},{daysInMonth:E,startingDayOfWeek:$}=P(r),l=()=>{a(new Date(r.getFullYear(),r.getMonth()-1))},v=()=>{a(new Date(r.getFullYear(),r.getMonth()+1))},C=x=>{const d=new Date(r.getFullYear(),r.getMonth(),x),f=Q(d,"yyyy-MM-dd");return N.get(f)},k=x=>{const d=new Date(r.getFullYear(),r.getMonth(),x),f=new Date;if(f.setHours(0,0,0,0),!g()&&d.getTime()!==f.getTime()){const u=d<f?"EdiÃ§Ã£o de dias passados disponÃ­vel apenas no plano Medium ou superior. FaÃ§a upgrade para acessar esta funcionalidade.":"EdiÃ§Ã£o de dias futuros disponÃ­vel apenas no plano Medium ou superior. FaÃ§a upgrade para acessar esta funcionalidade.";M.error(u);return}i(d)};return e.jsxs(e.Fragment,{children:[e.jsxs(ue,{className:"p-6 shadow-card",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h3",{className:"text-xl font-bold",children:[w[r.getMonth()]," ",r.getFullYear()]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(_,{variant:"outline",size:"icon",onClick:l,children:e.jsx(Re,{className:"h-4 w-4"})}),e.jsx(_,{variant:"outline",size:"icon",onClick:v,children:e.jsx(Pe,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-7 gap-2",children:[["Dom","Seg","Ter","Qua","Qui","Sex","SÃ¡b"].map(x=>e.jsx("div",{className:"text-center text-sm font-semibold text-muted-foreground p-2",children:x},x)),Array.from({length:$}).map((x,d)=>e.jsx("div",{},`empty-${d}`)),Array.from({length:E}).map((x,d)=>{const f=d+1,u=C(f),h=new Date(r.getFullYear(),r.getMonth(),f),c=new Date;c.setHours(0,0,0,0);const F=h.getTime()===c.getTime(),Y=h<c,L=h>c,m=!g()&&(Y||L);return e.jsxs("button",{onClick:()=>k(f),className:`
                  min-h-[80px] p-3 rounded-lg border transition-all hover:shadow-md relative group
                  ${F?"border-primary border-2":"border-border"}
                  ${Y&&u!==void 0?"bg-muted/50":"bg-card"}
                  hover:bg-accent
                `,children:[e.jsx("div",{className:"absolute top-2 right-2 text-lg font-bold text-primary group-hover:text-black transition-colors duration-200",children:f}),m&&e.jsx("div",{className:"absolute top-2 left-2",children:e.jsx($e,{className:"h-3 w-3 text-muted-foreground"})}),u!==void 0&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full pt-4",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"BRL"}),e.jsxs("div",{className:`text-sm font-bold ${u>=0?"text-success":"text-destructive"}`,children:[u>=0?"+":"","R$ ",u.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]},f)})]})]}),e.jsx(we,{open:!!n,onOpenChange:x=>!x&&i(null),children:e.jsxs(Se,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Ne,{children:e.jsxs(be,{children:["TransaÃ§Ãµes - ",n?.toLocaleDateString("pt-BR",{day:"2-digit",month:"long",year:"numeric"})]})}),n&&e.jsx(Qe,{date:n})]})})]})};class R{static startDailyClosureService(a){this.stopDailyClosureService();const n=this.getNextMidnightInSaoPaulo(),i=n.getTime()-new Date().getTime();console.log("ðŸ•› ServiÃ§o de fechamento diÃ¡rio iniciado"),console.log(`ðŸ“… PrÃ³ximo fechamento em: ${n.toLocaleString("pt-BR",{timeZone:"America/Sao_Paulo"})}`),this.closureInterval=setTimeout(()=>{this.processDailyClosure(a),this.closureInterval=setInterval(()=>{this.processDailyClosure(a)},24*60*60*1e3)},i)}static stopDailyClosureService(){this.closureInterval&&(clearTimeout(this.closureInterval),clearInterval(this.closureInterval),this.closureInterval=null,console.log("ðŸ›‘ ServiÃ§o de fechamento diÃ¡rio parado"))}static async processManualClosure(a,n){const i=n||this.getCurrentDateInSaoPaulo();await this.processDailyClosure(a,i)}static async processDailyClosure(a,n){if(this.isProcessing){console.log("âš ï¸ Fechamento diÃ¡rio jÃ¡ estÃ¡ sendo processado");return}this.isProcessing=!0;const i=n||this.getCurrentDateInSaoPaulo();try{console.log(`ðŸ”„ Iniciando fechamento diÃ¡rio para ${i}`);const y=await Ve.getTransactionsByDateRange(a,i,i);if(y.length===0){console.log("ðŸ“ Nenhuma transaÃ§Ã£o encontrada para o dia"),this.isProcessing=!1;return}const g=await this.calculateDailySummary(a,i,y),S=await this.getExistingSummary(a,i);S?(console.log("ðŸ“ Atualizando resumo existente"),await re.updateDailySummary(a,S.id,g)):(console.log("ðŸ“ Criando novo resumo diÃ¡rio"),await re.createDailySummary(a,g)),console.log(`âœ… Fechamento diÃ¡rio concluÃ­do para ${i}`),console.log(`ðŸ“Š Resumo: ${g.totalDeposits} depÃ³sitos, ${g.totalWithdraws} saques, ${g.totalProfit} lucro`)}catch(y){console.error("âŒ Erro no fechamento diÃ¡rio:",y)}finally{this.isProcessing=!1}}static async calculateDailySummary(a,n,i){const y=i.filter(l=>l.description&&l.description.startsWith("Surebet")),g=i.filter(l=>l.type==="deposit"&&(!l.description||!l.description.startsWith("Surebet"))),S=i.filter(l=>l.type==="withdraw"),b=y.reduce((l,v)=>l+(v.amount||0),0),N=g.reduce((l,v)=>l+(v.amount||0),0),w=S.reduce((l,v)=>l+(v.amount||0),0),P=w-N+b,E=i.reduce((l,v)=>{const C=v.employeeId;return l[C]||(l[C]={employeeId:C,employeeName:"FuncionÃ¡rio nÃ£o encontrado",deposits:0,withdraws:0,profit:0,transactionCount:0}),v.description&&v.description.startsWith("Surebet")?l[C].profit+=v.amount||0:v.type==="deposit"?l[C].deposits+=v.amount||0:l[C].withdraws+=v.amount||0,l[C].transactionCount++,l},{});Object.values(E).forEach(l=>{l.profit=l.profit+(l.withdraws-l.deposits)});const $=Object.values(E);return{date:n,totalDeposits:N,totalWithdraws:w,totalProfit:P,transactionCount:i.length,employeeSummaries:$}}static async getExistingSummary(a,n){try{return(await re.getDailySummaries(a)).find(y=>y.date===n)||null}catch(i){return console.error("Erro ao buscar resumo existente:",i),null}}static getNextMidnightInSaoPaulo(){const a=new Date,n=new Date(a.toLocaleString("en-US",{timeZone:"America/Sao_Paulo"})),i=new Date(n);return i.setDate(i.getDate()+1),i.setHours(0,0,0,0),new Date(i.toLocaleString("en-US",{timeZone:"UTC"}))}static getCurrentDateInSaoPaulo(){return new Date().toLocaleDateString("en-CA",{timeZone:"America/Sao_Paulo"})}static isServiceActive(){return this.closureInterval!==null}static getNextClosureInfo(){return{nextClosure:this.getNextMidnightInSaoPaulo(),isActive:this.isServiceActive()}}}oe(R,"closureInterval",null),oe(R,"isProcessing",!1);const Je=()=>{const{user:r}=Z(),[a,n]=T.useState(!1),[i,y]=T.useState(null);return T.useEffect(()=>{if(r?.uid){console.log("ðŸš€ Iniciando serviÃ§o de fechamento diÃ¡rio para usuÃ¡rio:",r.uid),R.startDailyClosureService(r.uid),n(R.isServiceActive());const{nextClosure:N}=R.getNextClosureInfo();y(N);const w=setInterval(()=>{n(R.isServiceActive());const{nextClosure:P}=R.getNextClosureInfo();y(P)},6e4);return()=>{clearInterval(w),R.stopDailyClosureService(),console.log("ðŸ›‘ ServiÃ§o de fechamento diÃ¡rio parado")}}},[r?.uid]),{isServiceActive:a,nextClosure:i,processManualClosure:async N=>{if(!r?.uid){M.error("UsuÃ¡rio nÃ£o autenticado");return}try{M.loading("Processando fechamento diÃ¡rio...",{id:"daily-closure"}),await R.processManualClosure(r.uid,N),M.success("Fechamento diÃ¡rio processado com sucesso!",{id:"daily-closure"})}catch(w){console.error("Erro no fechamento manual:",w),M.error("Erro ao processar fechamento diÃ¡rio",{id:"daily-closure"})}},stopService:()=>{R.stopDailyClosureService(),n(!1),y(null),M.info("ServiÃ§o de fechamento diÃ¡rio parado")},restartService:()=>{if(r?.uid){R.startDailyClosureService(r.uid),n(R.isServiceActive());const{nextClosure:N}=R.getNextClosureInfo();y(N),M.success("ServiÃ§o de fechamento diÃ¡rio reiniciado")}}}},vt=()=>{const{user:r}=Z(),a=Ge();Je();const{data:n=[],isLoading:i,error:y}=ye(r?.uid||""),g=De(),S=new Date(G().getTime()-7*24*60*60*1e3).toISOString().split("T")[0],b=new Date(G().getFullYear(),G().getMonth(),1).toISOString().split("T")[0],N=new Date(G().getFullYear(),G().getMonth()+1,0).toISOString().split("T")[0],{data:w=[],isLoading:P,error:E}=V(r?.uid||"",g,g),{data:$=[],isLoading:l}=V(r?.uid||"",S,g),{data:v=[],isLoading:C}=V(r?.uid||"",b,N),{data:k=[]}=de(r?.uid||""),x=ce(w),d=n?.filter(s=>s.status==="active")||[];w?.length;const f=G().getFullYear(),u=G().getMonth(),h=k.filter(s=>{const o=new Date(s.date);return o.getFullYear()===f&&o.getMonth()===u&&!H(s.date,g)}),c=h.reduce((s,o)=>s+(o.profit||o.margin||0),0),F=new Set(h.map(s=>s.date)),Y=v.filter(s=>{const o=s.date;return F.has(o)&&!H(o,g)?!1:(H(o,g),!0)}),L=ce(Y),m=c+L;d.length*1e4;const j=[{title:"Receita Hoje",value:`R$ ${x.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`,icon:pe,valueColor:x>=0?"positive":"negative",clickable:!0,onClick:()=>a("/resumo-dia")},{title:"Receita do MÃªs",value:`R$ ${m.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`,icon:m>=0?ne:ie,valueColor:m>=0?"positive":"negative",clickable:!0,onClick:()=>a("/relatorios")},{title:"FuncionÃ¡rios Ativos",value:d.length.toString(),icon:ge,valueColor:"default",clickable:!0,onClick:()=>a("/gestao-funcionarios")},{title:"TransaÃ§Ãµes do MÃªs",value:v.length.toString(),icon:ke,valueColor:"default",clickable:!0,onClick:()=>{a("/relatorios"),setTimeout(()=>{const s=document.getElementById("weekly-chart-section");s&&s.scrollIntoView({behavior:"smooth",block:"start"})},500)}}];(()=>{const s=["Dom","Seg","Ter","Qua","Qui","Sex","SÃ¡b"],o=[];for(let D=6;D>=0;D--){const A=new Date;A.setDate(A.getDate()-D);const O=A.toISOString().split("T")[0],me=$.filter(B=>new Date(B.createdAt?.toDate?.()||B.createdAt).toISOString().split("T")[0]===O),J=me.filter(B=>B.type==="withdraw").reduce((B,X)=>B+(Number(X.amount)||0),0),K=me.filter(B=>B.type==="deposit").reduce((B,X)=>B+(Number(X.amount)||0),0),Ce=o.length>0?o[o.length-1].lucroAcumulado+J-K:J-K;o.push({name:s[A.getDay()],receita:J,despesa:K,lucro:J-K,lucroAcumulado:Ce,date:O,isToday:D===0})}return o})();const p=()=>{const s=[];return $.sort((o,D)=>new Date(D.createdAt?.toDate?.()||D.createdAt).getTime()-new Date(o.createdAt?.toDate?.()||o.createdAt).getTime()).slice(0,5).forEach(o=>{const D=n.find(O=>O.id===o.employeeId),A=I(new Date(o.createdAt?.toDate?.()||o.createdAt));o.type==="withdraw"?s.push({id:`transaction-${o.id}`,action:"Pagamento recebido",employee:D?.name||"FuncionÃ¡rio nÃ£o encontrado",value:`R$ ${Number(o.amount||0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`,time:A,type:"payment",icon:pe}):o.type==="deposit"&&s.push({id:`transaction-${o.id}`,action:"Pagamento pendente",employee:D?.name||"FuncionÃ¡rio nÃ£o encontrado",value:`R$ ${Number(o.amount||0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`,time:A,type:"pending",icon:Ee})}),n.sort((o,D)=>new Date(D.createdAt?.toDate?.()||D.createdAt).getTime()-new Date(o.createdAt?.toDate?.()||o.createdAt).getTime()).slice(0,2).forEach(o=>{const D=I(new Date(o.createdAt?.toDate?.()||o.createdAt));s.push({id:`employee-${o.id}`,action:"Novo funcionÃ¡rio",employee:o.name,value:"",time:D,type:"employee",icon:Le})}),s.sort((o,D)=>{const A=W(o.time),O=W(D.time);return A-O}).slice(0,5)},I=s=>{const D=Math.floor((new Date-s)/(1e3*60));if(D<1)return"Agora mesmo";if(D<60)return`${D} min atrÃ¡s`;const A=Math.floor(D/60);if(A<24)return`${A} hora${A>1?"s":""} atrÃ¡s`;const O=Math.floor(A/24);return`${O} dia${O>1?"s":""} atrÃ¡s`},W=s=>s==="Agora mesmo"?0:s.includes("min")?parseInt(s):s.includes("hora")?parseInt(s)*60:s.includes("dia")?parseInt(s)*24*60:999999,U=p();return e.jsx(Ye,{children:e.jsxs("div",{className:"space-y-8 animate-fade-in",children:[e.jsxs("div",{children:[e.jsx(je,{className:"rounded-full bg-primary/10 px-4 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.35em] text-primary mb-4",children:"Dashboard"}),e.jsx("h1",{className:"text-4xl font-bold mb-2",children:"VisÃ£o Geral"}),e.jsx("p",{className:"text-muted-foreground",children:"Acompanhe seu negÃ³cio em tempo real"})]}),e.jsx("div",{className:"dashboard-grid",children:j.map(s=>e.jsx(Ue,{title:s.title,value:s.value,icon:s.icon,valueColor:s.valueColor,clickable:s.clickable,onClick:s.onClick},s.title))}),e.jsx(He,{}),e.jsx(Ze,{}),e.jsxs(ue,{className:"p-6 shadow-card hover:shadow-glow transition-all duration-300",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Atividades Recentes"}),e.jsx("div",{className:"space-y-4",children:U.length>0?U.map(s=>{const o=s.icon;return e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("div",{className:`p-2 rounded-full ${s.type==="payment"?"bg-success/10":s.type==="pending"?"bg-warning/10":"bg-primary/10"}`,children:e.jsx(o,{className:`h-4 w-4 ${s.type==="payment"?"text-success":s.type==="pending"?"text-warning":"text-primary"}`})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:s.action}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.employee})]})]}),e.jsxs("div",{className:"text-right",children:[s.value&&e.jsx("p",{className:`font-semibold ${s.type==="payment"?"text-success":s.type==="pending"?"text-warning":"text-foreground"}`,children:s.value}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.time})]})]},s.id)}):e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ge,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Nenhuma atividade recente"}),e.jsx("p",{className:"text-sm",children:"As atividades aparecerÃ£o aqui conforme vocÃª usa o sistema"})]})})]})]})})};export{vt as default};
