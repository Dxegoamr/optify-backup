var Ne=Object.defineProperty;var Se=(n,o,l)=>o in n?Ne(n,o,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[o]=l;var ae=(n,o,l)=>Se(n,typeof o!="symbol"?o+"":o,l);import{n as be,u as Ce,j as e,l as Me,i as M,o as re,e as ie,p as Te,q as $e,r as Ae,L as Fe,D as he,U as ge,F as Ie,s as Pe,t as Re}from"./ui-vendor-BKTCjC1N.js";import{D as Ee}from"./DashboardLayout-Bqy226V8.js";import{S as ke}from"./stat-card-CxIEjMW6.js";import{i as Q,C as ce,B as V,j as fe,k as Le,l as q,m as Be}from"./index-CNSrT_AO.js";import{r as T,R as Oe,u as Ye}from"./react-vendor-a_rYd-gI.js";import{D as xe,a as Ue,b as ye,c as ve,d as De}from"./dialog-D9Zm_o6s.js";import{I as le}from"./input-BpX8f5oW.js";import{L as W}from"./label-DVTuypfs.js";import{u as H,a as de,b as Ge,c as je,d as qe,e as We}from"./useFirestore-K8F5p6Y4.js";import{U as pe}from"./user-config.service-CQaSbsVc.js";import{S as ee,a as te,b as se,c as oe,d as G}from"./select-B02GmcUY.js";import{f as z}from"./format-DPwKrYwk.js";import{p as Ve}from"./pt-BR-DnZ5gAgy.js";import{a as He,b as ne}from"./user-specific.service-oo6Dy654.js";import"./firebase-vendor-Dsl9zeYT.js";import"./index-C3o8K6qv.js";import"./chart-vendor-CfBne3GF.js";import"./user-subcollections.service-rXnHzv2A.js";import"./index-CdAzXW5_.js";const ze=()=>{const n=be(),{user:o}=Q(),[l,c]=T.useState(""),[g,f]=T.useState(!1),{data:v}=Ce({queryKey:["user-config",o?.uid],queryFn:async()=>o?.uid?pe.getUserConfig(o.uid):null,enabled:!!o?.uid}),[D,N]=T.useState(v?.monthlyGoal||1e4);Oe.useEffect(()=>{v?.monthlyGoal&&N(v.monthlyGoal)},[v]);const r=new Date,j=new Date(r.getFullYear(),r.getMonth(),1),b=new Date(r.getFullYear(),r.getMonth()+1,0),P=j.toISOString().split("T")[0],Y=b.toISOString().split("T")[0],{data:F=[]}=H(o?.uid||"",P,Y),{data:U=[]}=de(o?.uid||""),R=r.getFullYear(),h=r.getMonth(),i=U.filter(u=>{const x=new Date(u.date);return x.getFullYear()===R&&x.getMonth()===h}),d=i.reduce((u,x)=>u+(x.profit||x.margin||0),0),m=new Set(i.map(u=>u.date)),w=F.filter(u=>!m.has(u.date)),S=w.reduce((u,x)=>{const s=x.type==="withdraw"?x.amount:-x.amount;return u+s},0),C=d+S,L=async()=>{const u=Number(l);if(u<=0){M.error("A meta deve ser maior que zero");return}try{o?.uid&&await pe.updateMonthlyGoal(o.uid,u),N(u),M.success("Meta atualizada!"),f(!1),c(""),n.invalidateQueries({queryKey:["user-config",o?.uid]})}catch(x){console.error("Erro ao atualizar meta:",x),M.error("Erro ao atualizar meta. Tente novamente.")}},I=D>0?Math.min(C/D*100,100):0;return console.log("MonthlyGoalCard Debug:",{monthlyProfit:C,monthlyGoal:D,progress:I,monthlyTransactions:F.length,monthlySummaries:i.length,monthlyRevenueFromSummaries:d,openTransactions:w.length,monthlyRevenueFromTransactions:S,startDate:P,endDate:Y}),console.log("MonthlyGoalCard - Fechamentos Diários:"),i.forEach((u,x)=>{console.log(`  ${x+1}. Data: ${u.date}, Profit: ${u.profit||u.margin||0}`)}),console.log("MonthlyGoalCard - Transações Abertas:"),w.forEach((u,x)=>{const s=u.type==="withdraw"?u.amount:-u.amount;console.log(`  ${x+1}. Data: ${u.date}, Tipo: ${u.type}, Valor: ${u.amount}, Profit: ${s}`)}),e.jsxs(ce,{className:"p-4 lg:p-6 shadow-card",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"Meta Mensal"}),e.jsxs("p",{className:"text-2xl lg:text-3xl font-bold leading-tight",children:["R$ ",D.toLocaleString("pt-BR")]})]}),e.jsxs(xe,{open:g,onOpenChange:f,children:[e.jsx(Ue,{asChild:!0,children:e.jsx("button",{className:"p-3 lg:p-4 bg-gradient-primary rounded-xl shadow-glow hover:shadow-glow-lg transition-all duration-300 cursor-pointer flex-shrink-0 ml-4",children:e.jsx(Me,{className:"h-5 w-5 lg:h-6 lg:w-6 text-primary-foreground"})})}),e.jsxs(ye,{children:[e.jsx(ve,{children:e.jsx(De,{children:"Alterar Meta Mensal"})}),e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{children:[e.jsx(W,{children:"Nova Meta (R$)"}),e.jsx(le,{type:"number",step:"0.01",placeholder:"0,00",value:l,onChange:u=>c(u.target.value)})]}),e.jsx(V,{className:"w-full",onClick:L,children:"Salvar Meta"})]})]})]})]}),e.jsxs("div",{className:"space-y-3 mb-4",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Progresso"}),e.jsxs("span",{className:"font-semibold text-primary",children:[I.toFixed(1),"%"]})]}),e.jsxs("div",{className:"relative w-full h-4 bg-muted rounded-full overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 left-0 h-full gradient-primary transition-all duration-1000 ease-out rounded-full",style:{width:`${Math.min(I,100)}%`,minWidth:I>0?"2px":"0px"}}),I>100&&e.jsx("div",{className:"absolute top-0 left-0 h-full gradient-success transition-all duration-1000 ease-out rounded-full w-full"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["R$ ",C.toLocaleString("pt-BR")," de R$ ",D.toLocaleString("pt-BR")]})]})]})},Qe=({date:n})=>{const{user:o}=Q(),{getAllowedEmployees:l}=fe(),[c,g]=T.useState(""),[f,v]=T.useState(""),[D,N]=T.useState("none"),[r,j]=T.useState("none"),[b,P]=T.useState("none"),[Y,F]=T.useState("none"),U=z(n,"yyyy-MM-dd"),{data:R=[]}=Ge(o?.uid||""),{data:h=[]}=je(o?.uid||""),i=l(h),{data:d=[]}=H(o?.uid||""),m=d.filter(s=>s.date===U),w=qe(),S=We(),C=async(s,y,B,_)=>{if(!o?.uid||!y){M.error("Preencha o valor da transação");return}try{const E={userId:o.uid,employeeId:_==="none"?"":_||"",platformId:B==="none"?"":B||"",type:s,amount:Number(y),date:U};console.log("Creating transaction for date:",U,E),console.log("Transaction data being sent:",JSON.stringify(E,null,2));const J=await w.mutateAsync(E);console.log("Transaction created successfully with ID:",J),M.success(`${s==="deposit"?"Depósito":"Saque"} registrado com sucesso!`),s==="deposit"?(g(""),N("none"),P("none")):(v(""),j("none"),F("none"))}catch(E){console.error("Erro ao criar transação:",E),console.error("Error details:",E),M.error("Erro ao registrar transação: "+E.message)}},L=async s=>{try{await S.mutateAsync(s),M.success("Transação excluída com sucesso!")}catch(y){console.error("Erro ao excluir transação:",y),M.error("Erro ao excluir transação")}},I=s=>s&&R.find(B=>B.id===s)?.name||"N/A",u=s=>R.find(B=>B.id===s)?.color||"#666",x=s=>s&&i.find(B=>B.id===s)?.name||"N/A";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-2xl font-bold mb-2",children:["Transações - ",z(n,"dd 'de' MMMM 'de' yyyy",{locale:Ve})]}),e.jsx("p",{className:"text-muted-foreground",children:"Gerencie as movimentações deste dia"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{className:"h-5 w-5 text-destructive"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Registrar Depósito"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"deposit-amount",children:"Valor (R$)"}),e.jsx(le,{id:"deposit-amount",type:"number",step:"0.01",placeholder:"0,00",value:c,onChange:s=>g(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"deposit-platform",children:"Plataforma (opcional)"}),e.jsxs(ee,{value:D,onValueChange:N,children:[e.jsx(te,{children:e.jsx(se,{placeholder:"Selecione uma plataforma..."})}),e.jsxs(oe,{children:[e.jsx(G,{value:"none",children:"Nenhuma plataforma"}),R.map(s=>e.jsx(G,{value:s.id,children:s.name},s.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"deposit-employee",children:"Funcionário (opcional)"}),e.jsxs(ee,{value:b,onValueChange:P,children:[e.jsx(te,{children:e.jsx(se,{placeholder:"Selecione um funcionário..."})}),e.jsxs(oe,{children:[e.jsx(G,{value:"none",children:"Nenhum funcionário"}),i.map(s=>e.jsx(G,{value:s.id,children:s.name},s.id))]})]})]}),e.jsxs(V,{onClick:()=>C("deposit",c,D,b),className:"w-full gap-2",disabled:!c||w.isPending,children:[e.jsx(re,{className:"h-4 w-4"}),"Registrar Depósito"]})]}),e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-5 w-5 text-success"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Registrar Saque"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"withdraw-amount",children:"Valor (R$)"}),e.jsx(le,{id:"withdraw-amount",type:"number",step:"0.01",placeholder:"0,00",value:f,onChange:s=>v(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"withdraw-platform",children:"Plataforma (opcional)"}),e.jsxs(ee,{value:r,onValueChange:j,children:[e.jsx(te,{children:e.jsx(se,{placeholder:"Selecione uma plataforma..."})}),e.jsxs(oe,{children:[e.jsx(G,{value:"none",children:"Nenhuma plataforma"}),R.map(s=>e.jsx(G,{value:s.id,children:s.name},s.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"withdraw-employee",children:"Funcionário (opcional)"}),e.jsxs(ee,{value:Y,onValueChange:F,children:[e.jsx(te,{children:e.jsx(se,{placeholder:"Selecione um funcionário..."})}),e.jsxs(oe,{children:[e.jsx(G,{value:"none",children:"Nenhum funcionário"}),i.map(s=>e.jsx(G,{value:s.id,children:s.name},s.id))]})]})]}),e.jsxs(V,{onClick:()=>C("withdraw",f,r,Y),className:"w-full gap-2",disabled:!f||w.isPending,children:[e.jsx(ie,{className:"h-4 w-4"}),"Registrar Saque"]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Transações do Dia"}),m.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Nenhuma transação registrada para este dia"}):e.jsx("div",{className:"space-y-2",children:m.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-accent/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Le,{variant:s.type==="deposit"?"default":"destructive",style:{backgroundColor:u(s.platformId)},children:s.type==="deposit"?"Depósito":"Saque"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:I(s.platformId)}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[x(s.employeeId)!=="N/A"&&e.jsxs("span",{className:"block",children:["Funcionário: ",x(s.employeeId)]}),e.jsx("span",{children:z(new Date(s.createdAt?.toDate?.()||s.date),"HH:mm")})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:`font-bold ${s.type==="deposit"?"text-destructive":"text-success"}`,children:[s.type==="deposit"?"+":"-","R$ ",Number(s.amount).toLocaleString("pt-BR")]}),e.jsx(V,{variant:"ghost",size:"icon",onClick:()=>L(s.id),className:"text-destructive hover:text-destructive",children:e.jsx(Te,{className:"h-4 w-4"})})]})]},s.id))})]}),m.length>0&&e.jsxs("div",{className:"p-4 bg-muted/50 rounded-lg",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Resumo do Dia"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Depósitos"}),e.jsxs("div",{className:"font-bold text-foreground",children:["R$ ",m.filter(s=>s.type==="deposit").reduce((s,y)=>s+Number(y.amount),0).toLocaleString("pt-BR")]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Saques"}),e.jsxs("div",{className:"font-bold text-foreground",children:["R$ ",m.filter(s=>s.type==="withdraw").reduce((s,y)=>s+Number(y.amount),0).toLocaleString("pt-BR")]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Lucro"}),e.jsxs("div",{className:`font-bold ${m.reduce((s,y)=>s+(y.type==="withdraw"?y.amount:-y.amount),0)>=0?"text-success":"text-destructive"}`,children:["R$ ",m.reduce((s,y)=>s+(y.type==="withdraw"?y.amount:-y.amount),0).toLocaleString("pt-BR")]})]})]})]})]})},_e=()=>{const[n,o]=T.useState(q()),[l,c]=T.useState(null),{user:g}=Q(),{canEditPreviousCalendarDays:f}=fe(),{data:v=[]}=de(g?.uid||""),{data:D=[]}=H(g?.uid||"");console.log("MonthlyCalendar - Historical Summaries:",v),console.log("MonthlyCalendar - Historical Summaries length:",v?.length||0),console.log("MonthlyCalendar - All Transactions:",D),console.log("MonthlyCalendar - All Transactions length:",D?.length||0),console.log("MonthlyCalendar - Current Date:",n),console.log("MonthlyCalendar - User ID:",g?.uid);const N=T.useMemo(()=>{const h=new Map;return console.log("Calculating daily profits..."),v.forEach(i=>{let d;typeof i.date=="string"?d=i.date:i.date&&i.date.toDate?d=z(i.date.toDate(),"yyyy-MM-dd"):d=z(new Date(i.date),"yyyy-MM-dd"),console.log(`Adding historical profit for ${d}: ${i.profit||i.margin}`),h.set(d,i.profit||i.margin||0)}),D.forEach(i=>{const d=i.date;console.log(`Processing transaction for date ${d}:`,i);const m=i.type==="withdraw"?i.amount:-i.amount;if(h.has(d)){const w=h.get(d)||0,S=w+m;console.log(`Adding to existing profit for ${d}: ${w} + ${m} = ${S}`),h.set(d,S)}else console.log(`Creating new profit for ${d}: ${m}`),h.set(d,m)}),console.log("Final daily profits Map:",Array.from(h.entries())),h},[v,D]),r=["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"],j=h=>{const i=h.getFullYear(),d=h.getMonth(),m=new Date(i,d,1),S=new Date(i,d+1,0).getDate(),C=m.getDay();return{daysInMonth:S,startingDayOfWeek:C}},{daysInMonth:b,startingDayOfWeek:P}=j(n),Y=()=>{o(new Date(n.getFullYear(),n.getMonth()-1))},F=()=>{o(new Date(n.getFullYear(),n.getMonth()+1))},U=h=>{const i=new Date(n.getFullYear(),n.getMonth(),h),d=z(i,"yyyy-MM-dd");console.log(`Looking for profit for day ${h}, date string: ${d}`);const m=N.get(d);return console.log(`Profit found for day ${h}:`,m),m},R=h=>{const i=new Date(n.getFullYear(),n.getMonth(),h),d=new Date;if(d.setHours(0,0,0,0),!f()&&i.getTime()!==d.getTime()){const m=i<d?"Edição de dias passados disponível apenas no plano Medium ou superior. Faça upgrade para acessar esta funcionalidade.":"Edição de dias futuros disponível apenas no plano Medium ou superior. Faça upgrade para acessar esta funcionalidade.";M.error(m);return}c(i)};return e.jsxs(e.Fragment,{children:[e.jsxs(ce,{className:"p-6 shadow-card",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h3",{className:"text-xl font-bold",children:[r[n.getMonth()]," ",n.getFullYear()]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(V,{variant:"outline",size:"icon",onClick:Y,children:e.jsx($e,{className:"h-4 w-4"})}),e.jsx(V,{variant:"outline",size:"icon",onClick:F,children:e.jsx(Ae,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-7 gap-2",children:[["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"].map(h=>e.jsx("div",{className:"text-center text-sm font-semibold text-muted-foreground p-2",children:h},h)),Array.from({length:P}).map((h,i)=>e.jsx("div",{},`empty-${i}`)),Array.from({length:b}).map((h,i)=>{const d=i+1,m=U(d),w=new Date(n.getFullYear(),n.getMonth(),d),S=new Date;S.setHours(0,0,0,0);const C=w.getTime()===S.getTime(),L=w<S,I=w>S,u=!f()&&(L||I);return e.jsxs("button",{onClick:()=>R(d),className:`
                  min-h-[80px] p-3 rounded-lg border transition-all hover:shadow-md relative group
                  ${C?"border-primary border-2":"border-border"}
                  ${L&&m!==void 0?"bg-muted/50":"bg-card"}
                  hover:bg-accent
                `,children:[e.jsx("div",{className:"absolute top-2 right-2 text-lg font-bold text-primary group-hover:text-black transition-colors duration-200",children:d}),u&&e.jsx("div",{className:"absolute top-2 left-2",children:e.jsx(Fe,{className:"h-3 w-3 text-muted-foreground"})}),m!==void 0&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full pt-4",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"BRL"}),e.jsxs("div",{className:`text-sm font-bold ${m>=0?"text-success":"text-destructive"}`,children:[m>=0?"+":"","R$ ",m.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]},d)})]})]}),e.jsx(xe,{open:!!l,onOpenChange:h=>!h&&c(null),children:e.jsxs(ye,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ve,{children:e.jsxs(De,{children:["Transações - ",l?.toLocaleDateString("pt-BR",{day:"2-digit",month:"long",year:"numeric"})]})}),l&&e.jsx(Qe,{date:l})]})})]})};class A{static startDailyClosureService(o){this.stopDailyClosureService();const l=this.getNextMidnightInSaoPaulo(),c=l.getTime()-new Date().getTime();console.log("🕛 Serviço de fechamento diário iniciado"),console.log(`📅 Próximo fechamento em: ${l.toLocaleString("pt-BR",{timeZone:"America/Sao_Paulo"})}`),this.closureInterval=setTimeout(()=>{this.processDailyClosure(o),this.closureInterval=setInterval(()=>{this.processDailyClosure(o)},24*60*60*1e3)},c)}static stopDailyClosureService(){this.closureInterval&&(clearTimeout(this.closureInterval),clearInterval(this.closureInterval),this.closureInterval=null,console.log("🛑 Serviço de fechamento diário parado"))}static async processManualClosure(o,l){const c=l||this.getCurrentDateInSaoPaulo();await this.processDailyClosure(o,c)}static async processDailyClosure(o,l){if(this.isProcessing){console.log("⚠️ Fechamento diário já está sendo processado");return}this.isProcessing=!0;const c=l||this.getCurrentDateInSaoPaulo();try{console.log(`🔄 Iniciando fechamento diário para ${c}`);const g=await He.getTransactionsByDateRange(o,c,c);if(g.length===0){console.log("📝 Nenhuma transação encontrada para o dia"),this.isProcessing=!1;return}const f=await this.calculateDailySummary(o,c,g),v=await this.getExistingSummary(o,c);v?(console.log("📝 Atualizando resumo existente"),await ne.updateDailySummary(o,v.id,f)):(console.log("📝 Criando novo resumo diário"),await ne.createDailySummary(o,f)),console.log(`✅ Fechamento diário concluído para ${c}`),console.log(`📊 Resumo: ${f.totalDeposits} depósitos, ${f.totalWithdraws} saques, ${f.totalProfit} lucro`)}catch(g){console.error("❌ Erro no fechamento diário:",g)}finally{this.isProcessing=!1}}static async calculateDailySummary(o,l,c){const g=c.filter(r=>r.type==="deposit").reduce((r,j)=>r+(j.amount||0),0),f=c.filter(r=>r.type==="withdraw").reduce((r,j)=>r+(j.amount||0),0),v=f-g,D=c.reduce((r,j)=>{const b=j.employeeId;return r[b]||(r[b]={employeeId:b,employeeName:"Funcionário não encontrado",deposits:0,withdraws:0,profit:0,transactionCount:0}),j.type==="deposit"?r[b].deposits+=j.amount||0:r[b].withdraws+=j.amount||0,r[b].transactionCount++,r},{});Object.values(D).forEach(r=>{r.profit=r.withdraws-r.deposits});const N=Object.values(D);return{date:l,totalDeposits:g,totalWithdraws:f,totalProfit:v,transactionCount:c.length,employeeSummaries:N}}static async getExistingSummary(o,l){try{return(await ne.getDailySummaries(o)).find(g=>g.date===l)||null}catch(c){return console.error("Erro ao buscar resumo existente:",c),null}}static getNextMidnightInSaoPaulo(){const o=new Date,l=new Date(o.toLocaleString("en-US",{timeZone:"America/Sao_Paulo"})),c=new Date(l);return c.setDate(c.getDate()+1),c.setHours(0,0,0,0),new Date(c.toLocaleString("en-US",{timeZone:"UTC"}))}static getCurrentDateInSaoPaulo(){return new Date().toLocaleDateString("en-CA",{timeZone:"America/Sao_Paulo"})}static isServiceActive(){return this.closureInterval!==null}static getNextClosureInfo(){return{nextClosure:this.getNextMidnightInSaoPaulo(),isActive:this.isServiceActive()}}}ae(A,"closureInterval",null),ae(A,"isProcessing",!1);const Je=()=>{const{user:n}=Q(),[o,l]=T.useState(!1),[c,g]=T.useState(null);return T.useEffect(()=>{if(n?.uid){console.log("🚀 Iniciando serviço de fechamento diário para usuário:",n.uid),A.startDailyClosureService(n.uid),l(A.isServiceActive());const{nextClosure:N}=A.getNextClosureInfo();g(N);const r=setInterval(()=>{l(A.isServiceActive());const{nextClosure:j}=A.getNextClosureInfo();g(j)},6e4);return()=>{clearInterval(r),A.stopDailyClosureService(),console.log("🛑 Serviço de fechamento diário parado")}}},[n?.uid]),{isServiceActive:o,nextClosure:c,processManualClosure:async N=>{if(!n?.uid){M.error("Usuário não autenticado");return}try{M.loading("Processando fechamento diário...",{id:"daily-closure"}),await A.processManualClosure(n.uid,N),M.success("Fechamento diário processado com sucesso!",{id:"daily-closure"})}catch(r){console.error("Erro no fechamento manual:",r),M.error("Erro ao processar fechamento diário",{id:"daily-closure"})}},stopService:()=>{A.stopDailyClosureService(),l(!1),g(null),M.info("Serviço de fechamento diário parado")},restartService:()=>{if(n?.uid){A.startDailyClosureService(n.uid),l(A.isServiceActive());const{nextClosure:N}=A.getNextClosureInfo();g(N),M.success("Serviço de fechamento diário reiniciado")}}}},xt=()=>{const{user:n}=Q(),o=Ye();Je();const{data:l=[],isLoading:c,error:g}=je(n?.uid||""),f=Be(),v=new Date(q().getTime()-7*24*60*60*1e3).toISOString().split("T")[0],D=new Date(q().getFullYear(),q().getMonth(),1).toISOString().split("T")[0],N=new Date(q().getFullYear(),q().getMonth()+1,0).toISOString().split("T")[0],{data:r=[],isLoading:j,error:b}=H(n?.uid||"",f,f),{data:P=[],isLoading:Y}=H(n?.uid||"",v,f),{data:F=[],isLoading:U}=H(n?.uid||"",D,N),{data:R=[]}=de(n?.uid||"");console.log("Dashboard Debug:",{user:n?.uid,employees:l.length,todayTransactions:r.length,today:f,employeesLoading:c,transactionsLoading:j,employeesError:g,transactionsError:b});const h=r?.filter(t=>t.type==="deposit")?.reduce((t,a)=>t+(a.amount||0),0)||0,d=(r?.filter(t=>t.type==="withdraw")?.reduce((t,a)=>t+(a.amount||0),0)||0)-h,m=l?.filter(t=>t.status==="active")||[];r?.length;const w=q().getFullYear(),S=q().getMonth(),C=R.filter(t=>{const a=new Date(t.date);return a.getFullYear()===w&&a.getMonth()===S}),L=C.reduce((t,a)=>t+(a.profit||a.margin||0),0),I=new Set(C.map(t=>t.date)),u=F.filter(t=>!I.has(t.date)),x=u.reduce((t,a)=>{const p=a.type==="withdraw"?a.amount:-a.amount;return t+p},0);console.log("Dashboard - Transações Abertas (não fechadas):",{totalMonthlyTransactions:F.length,closedDates:Array.from(I),openTransactions:u.length,monthlyRevenueFromTransactions:x});const s=L+x;console.log("Dashboard - Cálculo Receita Mensal:",{currentYear:w,currentMonth:S,monthlySummaries:C.length,monthlyRevenueFromSummaries:L,monthlyTransactions:F.length,monthlyRevenueFromTransactions:x,monthlyRevenue:s}),console.log("Dashboard - Fechamentos Diários Detalhados:"),C.forEach((t,a)=>{console.log(`  ${a+1}. Data: ${t.date}, Profit: ${t.profit||t.margin||0}`)}),console.log("Dashboard - Transações Abertas Detalhadas:"),u.forEach((t,a)=>{const p=t.type==="withdraw"?t.amount:-t.amount;console.log(`  ${a+1}. Data: ${t.date}, Tipo: ${t.type}, Valor: ${t.amount}, Profit: ${p}`)}),m.length*1e4;const y=[{title:"Receita Hoje",value:`R$ ${d.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`,icon:he,valueColor:d>=0?"positive":"negative",clickable:!0,onClick:()=>o("/resumo-dia")},{title:"Receita do Mês",value:`R$ ${s.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`,icon:s>=0?ie:re,valueColor:s>=0?"positive":"negative",clickable:!0,onClick:()=>o("/relatorios")},{title:"Funcionários Ativos",value:m.length.toString(),icon:ge,valueColor:"default",clickable:!0,onClick:()=>o("/gestao-funcionarios")},{title:"Transações do Mês",value:F.length.toString(),icon:Ie,valueColor:"default",clickable:!0,onClick:()=>{o("/relatorios"),setTimeout(()=>{const t=document.getElementById("weekly-chart-section");t&&t.scrollIntoView({behavior:"smooth",block:"start"})},500)}}];(()=>{const t=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"],a=[];for(let p=6;p>=0;p--){const $=new Date;$.setDate($.getDate()-p);const O=$.toISOString().split("T")[0],me=P.filter(k=>new Date(k.createdAt?.toDate?.()||k.createdAt).toISOString().split("T")[0]===O),Z=me.filter(k=>k.type==="withdraw").reduce((k,X)=>k+(Number(X.amount)||0),0),K=me.filter(k=>k.type==="deposit").reduce((k,X)=>k+(Number(X.amount)||0),0),we=a.length>0?a[a.length-1].lucroAcumulado+Z-K:Z-K;a.push({name:t[$.getDay()],receita:Z,despesa:K,lucro:Z-K,lucroAcumulado:we,date:O,isToday:p===0})}return a})();const _=()=>{const t=[];return P.sort((a,p)=>new Date(p.createdAt?.toDate?.()||p.createdAt).getTime()-new Date(a.createdAt?.toDate?.()||a.createdAt).getTime()).slice(0,5).forEach(a=>{const p=l.find(O=>O.id===a.employeeId),$=E(new Date(a.createdAt?.toDate?.()||a.createdAt));a.type==="withdraw"?t.push({id:`transaction-${a.id}`,action:"Pagamento recebido",employee:p?.name||"Funcionário não encontrado",value:`R$ ${Number(a.amount||0).toLocaleString("pt-BR")}`,time:$,type:"payment",icon:he}):a.type==="deposit"&&t.push({id:`transaction-${a.id}`,action:"Pagamento pendente",employee:p?.name||"Funcionário não encontrado",value:`R$ ${Number(a.amount||0).toLocaleString("pt-BR")}`,time:$,type:"pending",icon:Pe})}),l.sort((a,p)=>new Date(p.createdAt?.toDate?.()||p.createdAt).getTime()-new Date(a.createdAt?.toDate?.()||a.createdAt).getTime()).slice(0,2).forEach(a=>{const p=E(new Date(a.createdAt?.toDate?.()||a.createdAt));t.push({id:`employee-${a.id}`,action:"Novo funcionário",employee:a.name,value:"",time:p,type:"employee",icon:Re})}),t.sort((a,p)=>{const $=J(a.time),O=J(p.time);return $-O}).slice(0,5)},E=t=>{const p=Math.floor((new Date-t)/(1e3*60));if(p<1)return"Agora mesmo";if(p<60)return`${p} min atrás`;const $=Math.floor(p/60);if($<24)return`${$} hora${$>1?"s":""} atrás`;const O=Math.floor($/24);return`${O} dia${O>1?"s":""} atrás`},J=t=>t==="Agora mesmo"?0:t.includes("min")?parseInt(t):t.includes("hora")?parseInt(t)*60:t.includes("dia")?parseInt(t)*24*60:999999,ue=_();return e.jsx(Ee,{children:e.jsxs("div",{className:"space-y-8 animate-fade-in",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-4xl font-bold mb-2",children:"Dashboard"}),e.jsx("p",{className:"text-muted-foreground",children:"Visão geral do seu negócio"})]}),e.jsx("div",{className:"dashboard-grid",children:y.map(t=>e.jsx(ke,{title:t.title,value:t.value,icon:t.icon,valueColor:t.valueColor,clickable:t.clickable,onClick:t.onClick},t.title))}),e.jsx(ze,{}),e.jsx(_e,{}),e.jsxs(ce,{className:"p-6 shadow-card hover:shadow-glow transition-all duration-300",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Atividades Recentes"}),e.jsx("div",{className:"space-y-4",children:ue.length>0?ue.map(t=>{const a=t.icon;return e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("div",{className:`p-2 rounded-full ${t.type==="payment"?"bg-success/10":t.type==="pending"?"bg-warning/10":"bg-primary/10"}`,children:e.jsx(a,{className:`h-4 w-4 ${t.type==="payment"?"text-success":t.type==="pending"?"text-warning":"text-primary"}`})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:t.action}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.employee})]})]}),e.jsxs("div",{className:"text-right",children:[t.value&&e.jsx("p",{className:`font-semibold ${t.type==="payment"?"text-success":t.type==="pending"?"text-warning":"text-foreground"}`,children:t.value}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t.time})]})]},t.id)}):e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ge,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Nenhuma atividade recente"}),e.jsx("p",{className:"text-sm",children:"As atividades aparecerão aqui conforme você usa o sistema"})]})})]})]})})};export{xt as default};
