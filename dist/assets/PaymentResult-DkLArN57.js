import{j as e,ab as j,ac as B,a8 as D,s as F,y as T,d as M}from"./ui-vendor-BKTCjC1N.js";import{i as U,r as a,L as S}from"./react-vendor-a_rYd-gI.js";import{D as P}from"./DashboardLayout-q6rxeK_Q.js";import{i as L,d as z,C as _,B as b,U as q}from"./index-SqI1anxU.js";import{e as O}from"./env-14fk--Ss.js";import{e as G,I as H}from"./firebase-vendor-DKIO36wX.js";import"./input-D95wG3bR.js";import"./index-DIdW4MCp.js";import"./chart-vendor-2xH8hKrZ.js";function ae({mode:m}){const[$]=U(),l=$.get("payment_id"),[E,k]=a.useState(null),[I,v]=a.useState(!0),[s,x]=a.useState(m),[h,N]=a.useState(!1),[d,y]=a.useState(null),[R,V]=a.useState(!1),[w,C]=a.useState(m!=="pending"),{user:n}=L(),p=async()=>{if(n?.uid)try{const o=await q.getUserProfile(n.uid);y(o)}catch(o){console.error("Erro ao buscar perfil:",o)}},g=async()=>{if(l){N(!0);try{const u=`${O.API_URL||"https://us-central1-optify-definitivo.cloudfunctions.net"}/checkPaymentStatus?paymentId=${l}`;console.log("üîç Verificando status do pagamento:",u);const t=await fetch(u,{method:"GET",headers:{"Content-Type":"application/json"}}),i=t.headers.get("content-type");if(!i||!i.includes("application/json")){const f=await t.text();throw console.error("‚ùå Resposta n√£o √© JSON:",f.substring(0,200)),new Error(`Resposta inv√°lida: ${t.status} ${t.statusText}`)}if(!t.ok)throw new Error(`Erro HTTP: ${t.status} ${t.statusText}`);const c=await t.json();console.log("‚úÖ Status do pagamento recebido:",c?.status),k(c),c?.status==="approved"&&(x("success"),n?.uid&&await p())}catch(o){console.error("‚ùå Erro ao verificar status:",o)}finally{N(!1)}}};a.useEffect(()=>{n?.uid&&p()},[n?.uid]),a.useEffect(()=>{if(!n?.uid)return;console.log("üëÇ Iniciando listener do Firestore para plano do usu√°rio");const o=G(z,"users",n.uid),u=H(o,t=>{if(t.exists()){const i=t.data(),c=i?.plano||i?.plan||"free",f=d?.plano||"free";console.log("üìä Plano atualizado no Firestore:",{previousPlan:f,newPlan:c,isSubscriber:i?.isSubscriber,isActive:i?.isActive}),y(i),c!=="free"&&c!==f&&s==="pending"&&(console.log("‚úÖ Plano ativado! Mudando para success"),x("success"),p())}},t=>{console.error("‚ùå Erro no listener do Firestore:",t)});return()=>{console.log("üîá Removendo listener do Firestore"),u()}},[n?.uid,s]),a.useEffect(()=>{d?.plano&&d.plano!=="free"&&s==="pending"&&(console.log("‚úÖ Plano detectado! Mudando para success"),x("success"))},[d?.plano,s]),a.useEffect(()=>{s==="success"&&m!=="success"?(V(!0),setTimeout(()=>{C(!0)},1500)):C(!0)},[s,m]),a.useEffect(()=>{if(!l){v(!1);return}if(g(),v(!1),s==="pending"){const o=setInterval(()=>{g(),p()},5e3);return()=>clearInterval(o)}},[l,s]);const r=(()=>{switch(s){case"success":return{icon:M,title:"Pagamento Aprovado!",description:"Seu plano foi ativado com sucesso. Aproveite todos os recursos!",iconBg:"bg-emerald-500/10",iconColor:"text-emerald-500",titleColor:"text-foreground",descriptionColor:"text-muted-foreground",cardBg:"bg-background border-border",buttonVariant:"default",showRefresh:!1};case"failure":return{icon:T,title:"Pagamento Falhou",description:"N√£o foi poss√≠vel processar seu pagamento. Tente novamente.",iconBg:"bg-red-500/10",iconColor:"text-red-500",titleColor:"text-foreground",descriptionColor:"text-muted-foreground",cardBg:"bg-background border-border",buttonVariant:"default",showRefresh:!0};case"pending":return{icon:F,title:"Pagamento Pendente",description:"Seu pagamento est√° sendo processado. Verificando status automaticamente...",iconBg:"bg-amber-500/10",iconColor:"text-amber-500",titleColor:"text-foreground",descriptionColor:"text-muted-foreground",cardBg:"bg-background border-border",buttonVariant:"outline",showRefresh:!0}}})(),A=r.icon;return I?e.jsx(P,{children:e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(j,{className:"h-6 w-6 animate-spin text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground",children:"Carregando..."})]})})}):e.jsx(P,{children:e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4 relative",children:[R&&s==="success"&&e.jsx("div",{className:"fixed inset-0 pointer-events-none z-50",children:[...Array(50)].map((o,u)=>e.jsx("div",{className:"absolute animate-bounce",style:{left:`${Math.random()*100}%`,top:`${Math.random()*100}%`,animationDelay:`${Math.random()*2}s`,animationDuration:`${2+Math.random()*2}s`},children:e.jsx(B,{className:"h-4 w-4 text-emerald-500"})},u))}),e.jsx(_,{className:`w-full max-w-2xl p-8 ${r.cardBg} border shadow-lg transition-all duration-1000 ${w?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:`p-4 rounded-full ${r.iconBg} transition-all duration-1000 ${w?"scale-100":"scale-0"}`,children:e.jsx(A,{className:`h-12 w-12 ${r.iconColor} ${s==="success"?"animate-pulse":""}`})})}),e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("h1",{className:`text-4xl font-bold ${r.titleColor}`,children:r.title}),e.jsx("p",{className:`text-lg ${r.descriptionColor} max-w-md mx-auto`,children:r.description})]}),l&&e.jsx("div",{className:"bg-muted/50 rounded-xl p-6 border",children:e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("h3",{className:"font-semibold text-foreground",children:"Detalhes do Pagamento"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["ID: ",e.jsx("span",{className:"font-mono bg-muted px-2 py-1 rounded",children:l})]}),d?.plano&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Plano Atual: ",e.jsx("span",{className:"font-semibold text-foreground capitalize",children:d.plano})]})]})}),h&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-muted-foreground",children:[e.jsx(j,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm",children:"Verificando status..."})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-center",children:[e.jsx(b,{asChild:!0,className:"flex items-center gap-2",children:e.jsxs(S,{to:"/planos",children:[e.jsx(D,{className:"h-4 w-4"}),"Voltar aos Planos"]})}),e.jsx(b,{asChild:!0,variant:r.buttonVariant,children:e.jsx(S,{to:"/dashboard",children:"Ir para Dashboard"})}),r.showRefresh&&e.jsxs(b,{variant:"outline",onClick:g,disabled:h,className:"flex items-center gap-2",children:[e.jsx(j,{className:`h-4 w-4 ${h?"animate-spin":""}`}),"Verificar Status"]})]}),e.jsxs("div",{className:"text-center space-y-2 text-sm text-muted-foreground",children:[s==="success"&&e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"‚úÖ Seu plano foi ativado automaticamente"}),e.jsx("p",{children:"üéâ Voc√™ pode gerenciar sua assinatura no seu perfil"})]}),s==="failure"&&e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"‚ùå Se o problema persistir, entre em contato conosco"}),e.jsx("p",{children:"üí≥ Verifique se seus dados de pagamento est√£o corretos"})]}),s==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"‚è≥ O processamento pode levar alguns minutos"}),e.jsx("p",{children:"üìß Voc√™ receber√° um email quando o pagamento for confirmado"}),e.jsx("p",{children:"üîÑ Esta p√°gina atualiza automaticamente"})]})]}),E&&!1]})})]})})}export{ae as default};
